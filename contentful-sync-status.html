<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contentful åŒæ­¥ç‹€æ…‹</title>
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="contentful-sync-fixed.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }
    
    .status-card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .status-card h3 { color: #333; margin-bottom: 15px; }
    
    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    .btn:hover { background: #1e5bb8; }
    .btn-success { background: #28a745; }
    .btn-success:hover { background: #218838; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-warning:hover { background: #e0a800; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    
    .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
    .progress-fill { height: 100%; background: #28a745; transition: width 0.3s ease; }
    
    .sync-results { max-height: 400px; overflow-y: auto; }
    .sync-item { padding: 10px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 5px; }
    .sync-item.success { background: #d4edda; border-color: #c3e6cb; }
    .sync-item.error { background: #f8d7da; border-color: #f5c6cb; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .stat-number { font-size: 2rem; font-weight: bold; color: #2b71d2; }
    .stat-label { color: #666; margin-top: 5px; }
    
    .connection-status { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
    .connection-status.connected { background: #d4edda; color: #155724; }
    .connection-status.disconnected { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”„ Contentful åŒæ­¥ç‹€æ…‹</h1>
      <p>ç›£æ§å’Œç®¡ç†ç¯€ç›®åŒæ­¥åˆ° Contentful çš„ç‹€æ…‹</p>
    </div>
    
    <div class="status-card">
      <h3>ğŸ“¡ é€£æ¥ç‹€æ…‹</h3>
      <div id="connectionStatus">
        <span class="connection-status disconnected">æª¢æŸ¥ä¸­...</span>
      </div>
      <button class="btn" onclick="testConnection()">æ¸¬è©¦é€£æ¥</button>
    </div>
    
    <div class="status-card">
      <h3>ğŸ“Š åŒæ­¥çµ±è¨ˆ</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalPrograms">0</div>
          <div class="stat-label">æœ¬åœ°ç¯€ç›®ç¸½æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="syncedPrograms">0</div>
          <div class="stat-label">å·²åŒæ­¥ç¯€ç›®</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingPrograms">0</div>
          <div class="stat-label">å¾…åŒæ­¥ç¯€ç›®</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="failedPrograms">0</div>
          <div class="stat-label">åŒæ­¥å¤±æ•—</div>
        </div>
      </div>
    </div>
    
    <div class="status-card">
      <h3>ğŸ”„ åŒæ­¥æ“ä½œ</h3>
      <button class="btn btn-success" onclick="syncAllPrograms()">åŒæ­¥æ‰€æœ‰ç¯€ç›®</button>
      <button class="btn btn-warning" onclick="checkSyncStatus()">æª¢æŸ¥åŒæ­¥ç‹€æ…‹</button>
      <button class="btn" onclick="viewLocalPrograms()">æŸ¥çœ‹æœ¬åœ°ç¯€ç›®</button>
      <button class="btn" onclick="viewContentfulPrograms()">æŸ¥çœ‹ Contentful ç¯€ç›®</button>
    </div>
    
    <div class="status-card">
      <h3>ğŸ“ˆ åŒæ­¥é€²åº¦</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="syncProgress" style="width: 0%"></div>
      </div>
      <div id="syncStatus">æº–å‚™å°±ç·’</div>
    </div>
    
    <div class="status-card">
      <h3>ğŸ“‹ åŒæ­¥çµæœ</h3>
      <div class="sync-results" id="syncResults">
        <p style="color: #666; text-align: center;">å°šæœªåŸ·è¡ŒåŒæ­¥æ“ä½œ</p>
      </div>
    </div>
  </div>

  <script>
    let syncInProgress = false;
    
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      testConnection();
      updateStats();
    });
    
    // æ¸¬è©¦ Contentful é€£æ¥
    async function testConnection() {
      const statusElement = document.getElementById('connectionStatus');
      statusElement.innerHTML = '<span class="connection-status disconnected">æ¸¬è©¦ä¸­...</span>';
      
      try {
        const result = await window.contentfulSyncFixed.testConnection();
        if (result.success) {
          statusElement.innerHTML = '<span class="connection-status connected">âœ… å·²é€£æ¥</span>';
        } else {
          statusElement.innerHTML = '<span class="connection-status disconnected">âŒ é€£æ¥å¤±æ•—</span>';
        }
      } catch (error) {
        statusElement.innerHTML = '<span class="connection-status disconnected">âŒ é€£æ¥éŒ¯èª¤</span>';
        console.error('é€£æ¥æ¸¬è©¦å¤±æ•—:', error);
      }
    }
    
    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    function updateStats() {
      const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
      const publishedPrograms = JSON.parse(localStorage.getItem('published_programs') || '[]');
      
      let totalPrograms = 0;
      Object.keys(calendarEvents).forEach(date => {
        totalPrograms += calendarEvents[date].length;
      });
      
      const syncedPrograms = publishedPrograms.length;
      const pendingPrograms = totalPrograms - syncedPrograms;
      
      document.getElementById('totalPrograms').textContent = totalPrograms;
      document.getElementById('syncedPrograms').textContent = syncedPrograms;
      document.getElementById('pendingPrograms').textContent = Math.max(0, pendingPrograms);
      document.getElementById('failedPrograms').textContent = '0'; // éœ€è¦å¾åŒæ­¥çµæœä¸­ç²å–
    }
    
    // åŒæ­¥æ‰€æœ‰ç¯€ç›®
    async function syncAllPrograms() {
      if (syncInProgress) {
        alert('åŒæ­¥æ­£åœ¨é€²è¡Œä¸­ï¼Œè«‹ç¨å€™...');
        return;
      }
      
      syncInProgress = true;
      const progressBar = document.getElementById('syncProgress');
      const statusElement = document.getElementById('syncStatus');
      const resultsElement = document.getElementById('syncResults');
      
      try {
        // æª¢æŸ¥é€£æ¥
        const connectionTest = await window.contentfulSyncFixed.testConnection();
        if (!connectionTest.success) {
          throw new Error('Contentful é€£æ¥å¤±æ•—');
        }
        
        // ç²å–æ‰€æœ‰ç¯€ç›®
        const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
        const allPrograms = [];
        
        Object.keys(calendarEvents).forEach(date => {
          calendarEvents[date].forEach(event => {
            allPrograms.push({
              title: event.title,
              airDate: date,
              airTime: event.time,
              duration: event.duration,
              category: event.category,
              description: event.description || '',
              status: event.status,
              videoType: event.videoType || '',
              youtubeId: event.youtubeId || '',
              mp4File: event.mp4File || ''
            });
          });
        });
        
        if (allPrograms.length === 0) {
          statusElement.textContent = 'æ²’æœ‰ç¯€ç›®éœ€è¦åŒæ­¥';
          return;
        }
        
        statusElement.textContent = `é–‹å§‹åŒæ­¥ ${allPrograms.length} å€‹ç¯€ç›®...`;
        resultsElement.innerHTML = '';
        
        // åŸ·è¡ŒåŒæ­¥
        const results = await window.contentfulSyncFixed.syncAllPrograms();
        
        // é¡¯ç¤ºçµæœ
        displaySyncResults(results);
        
        // æ›´æ–°çµ±è¨ˆ
        updateStats();
        
        statusElement.textContent = 'åŒæ­¥å®Œæˆ';
        progressBar.style.width = '100%';
        
      } catch (error) {
        console.error('åŒæ­¥å¤±æ•—:', error);
        statusElement.textContent = 'åŒæ­¥å¤±æ•—: ' + error.message;
        resultsElement.innerHTML = `<div class="sync-item error">âŒ åŒæ­¥å¤±æ•—: ${error.message}</div>`;
      } finally {
        syncInProgress = false;
      }
    }
    
    // é¡¯ç¤ºåŒæ­¥çµæœ
    function displaySyncResults(results) {
      const resultsElement = document.getElementById('syncResults');
      resultsElement.innerHTML = '';
      
      const successCount = results.filter(r => r.success).length;
      const failCount = results.filter(r => !r.success).length;
      
      resultsElement.innerHTML = `
        <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
          <strong>åŒæ­¥æ‘˜è¦:</strong> ${successCount} æˆåŠŸ, ${failCount} å¤±æ•—
        </div>
      `;
      
      results.forEach((result, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `sync-item ${result.success ? 'success' : 'error'}`;
        
        if (result.success) {
          itemDiv.innerHTML = `
            âœ… <strong>${result.program.title}</strong> (${result.program.airDate} ${result.program.airTime})
            <br><small>åŒæ­¥æˆåŠŸ</small>
          `;
        } else {
          itemDiv.innerHTML = `
            âŒ <strong>${result.program.title}</strong> (${result.program.airDate} ${result.program.airTime})
            <br><small>éŒ¯èª¤: ${result.error}</small>
          `;
        }
        
        resultsElement.appendChild(itemDiv);
      });
    }
    
    // æª¢æŸ¥åŒæ­¥ç‹€æ…‹
    function checkSyncStatus() {
      updateStats();
      alert('åŒæ­¥ç‹€æ…‹å·²æ›´æ–°');
    }
    
    // æŸ¥çœ‹æœ¬åœ°ç¯€ç›®
    function viewLocalPrograms() {
      const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
      const allPrograms = [];
      
      Object.keys(calendarEvents).forEach(date => {
        calendarEvents[date].forEach(event => {
          allPrograms.push({
            title: event.title,
            date: date,
            time: event.time,
            category: event.category,
            status: event.status
          });
        });
      });
      
      console.log('æœ¬åœ°ç¯€ç›®:', allPrograms);
      alert(`æœ¬åœ°å…±æœ‰ ${allPrograms.length} å€‹ç¯€ç›®\nè«‹æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å°ç²å–è©³ç´°è³‡è¨Š`);
    }
    
    // æŸ¥çœ‹ Contentful ç¯€ç›®
    async function viewContentfulPrograms() {
      try {
        // é€™è£¡éœ€è¦å¯¦ç¾å¾ Contentful ç²å–ç¯€ç›®çš„åŠŸèƒ½
        alert('æ­¤åŠŸèƒ½éœ€è¦é€²ä¸€æ­¥å¯¦ç¾ Contentful è®€å–åŠŸèƒ½');
      } catch (error) {
        console.error('ç²å– Contentful ç¯€ç›®å¤±æ•—:', error);
        alert('ç²å– Contentful ç¯€ç›®å¤±æ•—: ' + error.message);
      }
    }
  </script>
</body>
</html>
