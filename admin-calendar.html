<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœˆæ›†ç¯€ç›®ç®¡ç† - èˆªå‘ä¸–ç•Œæ—…éŠé »é“</title>
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
         .container { 
       max-width: 1400px; 
       margin: 0 auto; 
       padding: 20px; 
       width: 100%;
       box-sizing: border-box;
     }
    
    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }
    .header p { color: #666; }
    
    .calendar-controls { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .month-nav { display: flex; align-items: center; gap: 15px; }
    .month-nav button { background: #2b71d2; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .month-nav button:hover { background: #1e5bb8; }
    .current-month { font-size: 1.2rem; font-weight: 600; color: #333; }
    
         .calendar-grid { 
       background: white; 
       border-radius: 10px; 
       overflow: hidden; 
       box-shadow: 0 2px 10px rgba(0,0,0,0.1);
       width: 100%;
       min-width: 100%;
     }
     .calendar-header { 
       display: grid; 
       grid-template-columns: repeat(7, 1fr); 
       background: #2b71d2; 
       color: white;
       width: 100%;
       min-width: 100%;
     }
         .calendar-header div { 
       padding: 15px; 
       text-align: center; 
       font-weight: 600; 
       width: 100%;
       box-sizing: border-box;
       flex: 1;
     }
    
         .calendar-body { 
       display: grid; 
       grid-template-columns: repeat(7, 1fr); 
       width: 100%;
       min-width: 100%;
     }
     .calendar-day { 
       min-height: 200px; 
       border: 1px solid #eee; 
       padding: 10px; 
       position: relative; 
       background: white;
       width: 100%;
       box-sizing: border-box;
       flex: 1;
       min-width: 0;
       overflow-y: auto;
     }
    .calendar-day:hover { background: #f8f9fa; }
    .calendar-day.other-month { background: #f8f9fa; color: #999; }
    .calendar-day.today { background: #e3f2fd; border-color: #2b71d2; }
    
         .day-number { font-weight: 600; margin-bottom: 5px; color: #333; }
     .day-programs { font-size: 0.8rem; }
     
     /* æ™‚æ®µåˆ†çµ„æ¨£å¼ */
     .period-group {
       margin-bottom: 15px;
       border: 1px solid #e9ecef;
       border-radius: 8px;
       overflow: hidden;
     }
     
     .period-header {
       background: #f8f9fa;
       padding: 8px 12px;
       font-weight: 600;
       font-size: 0.9rem;
       color: #495057;
       border-bottom: 1px solid #e9ecef;
     }
     
     .prime-time-header {
       background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
       color: white;
       font-weight: 700;
     }
     
           .period-slots {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 3px;
        padding: 8px;
        background: white;
        min-height: 60px;
      }
     
           .program-slot { 
        background: #e8f5e8; 
        border: 1px solid #4caf50; 
        border-radius: 4px; 
        padding: 6px 8px; 
        cursor: pointer;
        font-size: 0.7rem;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: all 0.2s ease;
        position: relative;
        word-wrap: break-word;
        overflow: hidden;
      }
     
     .program-slot:hover { 
       background: #c8e6c9; 
       transform: translateY(-1px);
       box-shadow: 0 2px 8px rgba(0,0,0,0.1);
     }
     
     .program-slot.empty { 
       background: #fff3cd; 
       border-color: #ffc107; 
       color: #856404;
       font-style: italic;
     }
     
     .program-slot.empty:hover { background: #ffeaa7; }
     
     .program-slot.prime-time {
       border-color: #ff6b6b;
       background: #ffe8e8;
     }
     
     .program-slot.prime-time:hover {
       background: #ffd8d8;
     }
     
     .slot-time {
       font-size: 0.6rem;
       color: #666;
       font-weight: 600;
       margin-bottom: 2px;
     }
     
           .program-title {
        font-size: 0.65rem;
        font-weight: 500;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        word-break: break-word;
        hyphens: auto;
        max-height: 2.4em;
      }
     
     .slot-status {
       font-size: 0.6rem;
       color: #999;
       font-style: italic;
     }
     
     .first-air-badge {
       position: absolute;
       top: 2px;
       right: 2px;
       background: #ff6b6b;
       color: white;
       font-size: 0.5rem;
       padding: 1px 4px;
       border-radius: 2px;
       font-weight: 600;
     }
    
    .program-modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: 1000;
    }
    .modal-content { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: white; 
      padding: 30px; 
      border-radius: 10px; 
      width: 90%; 
      max-width: 600px; 
      max-height: 80vh; 
      overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-group textarea { height: 80px; resize: vertical; }
    
    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    .btn:hover { background: #1e5bb8; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    
    /* æª”æ¡ˆä¸Šå‚³æ¨£å¼ */
    .file-upload-container {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #f8f9fa;
      transition: all 0.3s ease;
    }
    
    .file-upload-container:hover {
      border-color: #2b71d2;
      background: #e3f2fd;
    }
    
    .file-upload-btn {
      background: linear-gradient(135deg, #2b71d2 0%, #1e5bb8 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(43, 113, 210, 0.3);
    }
    
    .file-upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(43, 113, 210, 0.4);
    }
    
    .file-info {
      margin-top: 10px;
      padding: 10px;
      background: #e8f5e8;
      border-radius: 6px;
      border: 1px solid #4caf50;
    }
    
    .upload-progress {
      margin-top: 10px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 5px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* ç¸®åœ–ä¸Šå‚³æ¨£å¼ */
    .thumbnail-upload-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .thumbnail-upload-btn, .auto-thumbnail-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .thumbnail-upload-btn:hover, .auto-thumbnail-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .auto-thumbnail-btn {
      background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
      color: #333;
    }
    
    .thumbnail-preview {
      position: relative;
      display: inline-block;
      max-width: 200px;
    }
    
    .thumbnail-preview img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }
    
    .remove-thumbnail {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .form-help {
      color: #6c757d;
      font-size: 12px;
      margin-top: 5px;
      display: block;
    }
    
    .template-panel { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .template-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
    .template-card { 
      background: #f8f9fa; 
      border: 2px solid #e9ecef; 
      border-radius: 8px; 
      padding: 15px; 
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    .template-card:hover { border-color: #2b71d2; background: #e3f2fd; }
    .template-card.selected { border-color: #2b71d2; background: #e3f2fd; }
    .template-card h4 { margin-bottom: 8px; color: #333; }
    .template-card p { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
    
    .status-bar { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      background: #333; 
      color: white; 
      padding: 15px 20px; 
      border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1001;
      display: none;
    }
    
    .auto-fill-panel { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .auto-fill-options { display: flex; gap: 15px; margin-top: 15px; }
    .auto-fill-option { 
      background: #f8f9fa; 
      border: 1px solid #ddd; 
      border-radius: 5px; 
      padding: 10px; 
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .auto-fill-option:hover { border-color: #2b71d2; background: #e3f2fd; }
    
    .stats { display: flex; gap: 20px; margin-top: 15px; }
    .stat-item { 
      background: #e3f2fd; 
      padding: 10px 15px; 
      border-radius: 5px; 
      text-align: center;
    }
    .stat-number { font-size: 1.5rem; font-weight: 600; color: #2b71d2; }
    .stat-label { font-size: 0.9rem; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“… æœˆæ›†ç¯€ç›®ç®¡ç†ç³»çµ±</h1>
      <p>ç›´è§€çš„æœˆæ›†ä»‹é¢ï¼Œè¼•é¬†ç®¡ç†æ•´å€‹æœˆçš„ç¯€ç›®å®‰æ’</p>
    </div>
    
         <!-- æœˆæ›†æ§åˆ¶ -->
     <div class="calendar-controls">
               <div class="month-nav">
          <button onclick="previousMonth()">â—€ ä¸Šå€‹æœˆ</button>
          <span class="current-month" id="currentMonth">2024å¹´1æœˆ</span>
          <button onclick="nextMonth()">ä¸‹å€‹æœˆ â–¶</button>
          <div class="current-time" id="currentTime" style="margin-left: 20px; font-size: 0.9rem; color: #666;"></div>
        </div>
              <div>
          <button class="btn btn-secondary" onclick="window.location.href='admin-dashboard.html'">ğŸ  è¿”å›ä¸»æ§å°</button>
          <button class="btn" onclick="saveToContentful()">ğŸ’¾ å„²å­˜åˆ° Contentful</button>
          <button class="btn btn-secondary" onclick="exportCalendar()">ğŸ“¤ åŒ¯å‡ºæœˆæ›†</button>
                     <button class="btn" onclick="showAutoFillPanel()">ğŸ”§ è‡ªå‹•å¡«å……</button>
                       <button class="btn btn-secondary" onclick="diagnoseContentful()">ğŸ” è¨ºæ–· Contentful</button>
            <button class="btn btn-secondary" onclick="debugTimeFilter()">ğŸ› èª¿è©¦æ™‚é–“éæ¿¾</button>
            <button class="btn btn-secondary" onclick="debugWeekCalculation()">ğŸ“… èª¿è©¦æ˜ŸæœŸè¨ˆç®—</button>
            <button class="btn btn-secondary" onclick="debugCalendarLayout()">ğŸ“ èª¿è©¦ç‰ˆé¢</button>
            <button class="btn btn-secondary" onclick="debugTimeSlots()">â° èª¿è©¦æ™‚é–“æ§½</button>
            <button class="btn btn-danger" onclick="logout()">ğŸšª ç™»å‡º</button>
        </div>
     </div>
    
    <!-- è‡ªå‹•å¡«å……é¢æ¿ -->
    <div class="auto-fill-panel" id="autoFillPanel" style="display: none;">
      <h3>ğŸ”§ è‡ªå‹•å¡«å……é¸é …</h3>
      <div class="auto-fill-options">
        <div class="auto-fill-option" onclick="autoFillEmptySlots()">
          <h4>ğŸ”„ è‡ªå‹•å¡«å……ç©ºç™½æ™‚æ®µ</h4>
          <p>ä½¿ç”¨ç¾æœ‰ç¯€ç›®è‡ªå‹•å¡«å……æ²’æœ‰å®‰æ’çš„æ™‚æ®µ</p>
        </div>
        <div class="auto-fill-option" onclick="generateWeeklyPattern()">
          <h4>ğŸ“… ç”Ÿæˆé€±æœŸæ¨¡å¼</h4>
          <p>æ ¹æ“šé€±ä¸€è‡³é€±æ—¥çš„æ¨¡å¼è‡ªå‹•å®‰æ’ç¯€ç›®</p>
        </div>
        <div class="auto-fill-option" onclick="duplicateWeek()">
          <h4>ğŸ“‹ è¤‡è£½ä¸Šé€±å®‰æ’</h4>
          <p>å°‡ä¸Šé€±çš„ç¯€ç›®å®‰æ’è¤‡è£½åˆ°æœ¬é€±</p>
        </div>
      </div>
    </div>
    
    <!-- ç¯€ç›®ç¯„æœ¬é¢æ¿ -->
    <div class="template-panel">
      <h3>ğŸ“‹ ç¯€ç›®ç¯„æœ¬åº«</h3>
      <p>é»æ“Šç¯„æœ¬å¯å¿«é€Ÿæ·»åŠ åˆ°é¸å®šçš„æ™‚æ®µ</p>
      <div class="template-grid" id="templateGrid">
        <!-- ç¯„æœ¬å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
    
    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number" id="totalPrograms">0</div>
        <div class="stat-label">ç¸½ç¯€ç›®æ•¸</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="emptySlots">0</div>
        <div class="stat-label">ç©ºç™½æ™‚æ®µ</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="coverageRate">0%</div>
        <div class="stat-label">è¦†è“‹ç‡</div>
      </div>
    </div>
    
    <!-- æœˆæ›†ç¶²æ ¼ -->
    <div class="calendar-grid">
      <div class="calendar-header">
        <div>æ˜ŸæœŸæ—¥</div>
        <div>æ˜ŸæœŸä¸€</div>
        <div>æ˜ŸæœŸäºŒ</div>
        <div>æ˜ŸæœŸä¸‰</div>
        <div>æ˜ŸæœŸå››</div>
        <div>æ˜ŸæœŸäº”</div>
        <div>æ˜ŸæœŸå…­</div>
      </div>
      <div class="calendar-body" id="calendarBody">
        <!-- æœˆæ›†å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
  </div>
  
  <!-- ç¯€ç›®ç·¨è¼¯æ¨¡æ…‹æ¡† -->
  <div class="program-modal" id="programModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">ç·¨è¼¯ç¯€ç›®</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <form id="programForm">
        <input type="hidden" id="editDate">
        <input type="hidden" id="editTime">
        
                 <div class="form-group">
           <label>æ’­å‡ºæ™‚é–“ï¼š</label>
           <input type="time" id="airTime" required readonly style="background-color: #f8f9fa; color: #495057;">
           <small class="form-help">æ™‚é–“ç”±é¸å®šçš„æ™‚æ®µè‡ªå‹•å¸¶å‡ºï¼Œä¸å¯ä¿®æ”¹</small>
         </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æ¨™é¡Œï¼š</label>
          <input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šæ—©å®‰ä¸–ç•Œ - æ—¥æœ¬æ±äº¬æ™¨é–“æ¼«æ­¥" required>
        </div>
        
                 <div class="form-group">
           <label>ç¯€ç›®æ™‚é•·ï¼š</label>
           <select id="duration" required>
             <option value="30" selected>30åˆ†é˜ (æ¨™æº–æ™‚æ®µ)</option>
             <option value="60">60åˆ†é˜ (é›™æ™‚æ®µ)</option>
             <option value="90">90åˆ†é˜ (ä¸‰æ™‚æ®µ)</option>
           </select>
           <small class="form-help">æ¯å€‹æ™‚æ®µç‚º30åˆ†é˜ï¼Œå¯é¸æ“‡å¤šå€‹æ™‚æ®µçµ„åˆ</small>
         </div>
        
        <div class="form-group">
          <label>ç¯€ç›®åˆ†é¡ï¼š</label>
          <select id="category" required>
            <option value="">-- é¸æ“‡åˆ†é¡ --</option>
            <option value="äºæ´²æ—…éŠ">äºæ´²æ—…éŠ</option>
            <option value="æ­æ´²æ—…éŠ">æ­æ´²æ—…éŠ</option>
            <option value="ç¾æ´²æ—…éŠ">ç¾æ´²æ—…éŠ</option>
            <option value="ç¾é£Ÿæ—…éŠ">ç¾é£Ÿæ—…éŠ</option>
            <option value="æ¥µåœ°æ—…éŠ">æ¥µåœ°æ—…éŠ</option>
            <option value="è‡ªç„¶æ—…éŠ">è‡ªç„¶æ—…éŠ</option>
            <option value="æ–‡åŒ–æ—…éŠ">æ–‡åŒ–æ—…éŠ</option>
            <option value="å†’éšªæ—…éŠ">å†’éšªæ—…éŠ</option>
          </select>
        </div>
        
                 <div class="form-group">
           <label>å½±ç‰‡é¡å‹ï¼š</label>
           <select id="videoType" onchange="toggleVideoInput()">
             <option value="YouTube">YouTube</option>
             <option value="MP4">MP4 æª”æ¡ˆ</option>
           </select>
         </div>
         
         <div class="form-group" id="youtubeGroup">
           <label>YouTube IDï¼š</label>
           <input type="text" id="youtubeId" placeholder="ä¾‹å¦‚ï¼šdQw4w9WgXcQ">
         </div>
         
         <div class="form-group" id="mp4Group" style="display: none;">
           <label>MP4 å½±ç‰‡ï¼š</label>
           <div class="file-upload-container">
             <input type="file" id="mp4File" accept="video/mp4,video/avi,video/mov,video/wmv" style="display: none;">
             <button type="button" class="file-upload-btn" onclick="document.getElementById('mp4File').click()">
               ğŸ“ é¸æ“‡å½±ç‰‡æª”æ¡ˆ
             </button>
             <div id="fileInfo" class="file-info" style="display: none;">
               <span id="fileName"></span>
               <span id="fileSize"></span>
             </div>
             <div id="uploadProgress" class="upload-progress" style="display: none;">
               <div class="progress-bar">
                 <div class="progress-fill" id="progressFill"></div>
               </div>
               <span id="progressText">0%</span>
             </div>
           </div>
           <small class="form-help">æ”¯æ´ MP4ã€AVIã€MOVã€WMV æ ¼å¼ï¼Œæœ€å¤§ 500MB</small>
         </div>
         
         <div class="form-group">
           <label>ç¯€ç›®æè¿°ï¼š</label>
           <textarea id="description" placeholder="ç°¡çŸ­æè¿°ç¯€ç›®å…§å®¹..."></textarea>
         </div>
         
         <div class="form-group">
           <label>ç¯€ç›®ç¸®åœ–ï¼š</label>
           <div class="thumbnail-upload-container">
             <input type="file" id="thumbnailFile" accept="image/*" style="display: none;">
             <button type="button" class="thumbnail-upload-btn" onclick="document.getElementById('thumbnailFile').click()">
               ğŸ–¼ï¸ é¸æ“‡ç¸®åœ–
             </button>
             <div id="thumbnailPreview" class="thumbnail-preview" style="display: none;">
               <img id="thumbnailImg" src="" alt="ç¯€ç›®ç¸®åœ–">
               <button type="button" class="remove-thumbnail" onclick="removeThumbnail()">âŒ</button>
             </div>
             <button type="button" class="auto-thumbnail-btn" onclick="generateAutoThumbnail()">
               ğŸ¬ è‡ªå‹•ç”Ÿæˆç¸®åœ–
             </button>
           </div>
           <small class="form-help">å»ºè­°å°ºå¯¸ 1280x720ï¼Œæ”¯æ´ JPGã€PNG æ ¼å¼</small>
         </div>
        
                 <div class="form-group">
           <label>ç¯€ç›®ç‹€æ…‹ï¼š</label>
           <select id="status" onchange="toggleProgramSelection()">
             <option value="é‡æ’­">é‡æ’­</option>
             <option value="é¦–æ’­">é¦–æ’­</option>
             <option value="ç‰¹åˆ¥ç¯€ç›®">ç‰¹åˆ¥ç¯€ç›®</option>
           </select>
         </div>
         
         <div class="form-group" id="programSelectionGroup" style="display: none;">
           <label>é¸æ“‡é¦–æ’­ç¯€ç›®ï¼š</label>
           <select id="programSelection">
             <option value="">-- å¾ç¯€ç›®åº«é¸æ“‡ --</option>
           </select>
           <button type="button" class="btn btn-secondary" onclick="loadProgramLibrary()" style="margin-top: 5px;">
             ğŸ”„ é‡æ–°è¼‰å…¥ç¯€ç›®åº«
           </button>
         </div>
        
        <button type="submit" class="btn">ğŸ’¾ å„²å­˜ç¯€ç›®</button>
        <button type="button" class="btn btn-danger" onclick="deleteProgram()">ğŸ—‘ï¸ åˆªé™¤ç¯€ç›®</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">âŒ å–æ¶ˆ</button>
      </form>
    </div>
  </div>
  
  <!-- ç‹€æ…‹æ¬„ -->
  <div class="status-bar" id="statusBar">
    <span id="statusMessage"></span>
  </div>

  <script>
    // ç™»å…¥é©—è­‰æª¢æŸ¥
    function checkAuth() {
      const user = sessionStorage.getItem('adminUser');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!user || !loginTime) {
        // æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢
        window.location.href = 'admin-login.html';
        return null;
      }
      
      // æª¢æŸ¥ç™»å…¥æ˜¯å¦è¶…é 8 å°æ™‚
      const loginDate = new Date(loginTime);
      const now = new Date();
      const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
      
      if (hoursDiff >= 8) {
        // ç™»å…¥å·²éæœŸï¼Œæ¸…é™¤ session ä¸¦è·³è½‰åˆ°ç™»å…¥é é¢
        sessionStorage.removeItem('adminUser');
        sessionStorage.removeItem('loginTime');
        window.location.href = 'admin-login.html';
        return null;
      }
      
      return JSON.parse(user);
    }
    
    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      sessionStorage.removeItem('adminUser');
      sessionStorage.removeItem('loginTime');
      window.location.href = 'admin-login.html';
    }
    
    // å…¨åŸŸè®Šæ•¸
    let currentDate = new Date(); // ä½¿ç”¨ç•¶å‰å¯¦éš›æ—¥æœŸ
    let calendarData = {};
    let selectedTemplate = null;
    let selectedSlot = null;
    let currentUser = null;
    
    // çµ±ä¸€çš„è³‡æ–™ç®¡ç†
    const DATA_KEYS = {
      PROGRAMS: 'tv_programs_data',
      ARCHIVES: 'tv_archives_data',
      TEMPLATES: 'tv_templates_data'
    };
    
    // è¼‰å…¥æ‰€æœ‰ç¯€ç›®è³‡æ–™
    function loadAllPrograms() {
      try {
        const savedData = localStorage.getItem(DATA_KEYS.PROGRAMS);
        if (savedData) {
          const allPrograms = JSON.parse(savedData);
          // å°‡æ‰€æœ‰ç¯€ç›®è³‡æ–™è½‰æ›ç‚ºæœˆæ›†æ ¼å¼
          allPrograms.forEach(program => {
            const slotKey = `${program.airDate}-${program.airTime}`;
            calendarData[slotKey] = program;
          });
          console.log(`å·²è¼‰å…¥ ${allPrograms.length} å€‹ç¯€ç›®è³‡æ–™`);
        }
      } catch (error) {
        console.error('è¼‰å…¥ç¯€ç›®è³‡æ–™å¤±æ•—:', error);
      }
    }
    
    // å„²å­˜æ‰€æœ‰ç¯€ç›®è³‡æ–™
    function saveAllPrograms() {
      try {
        const allPrograms = Object.values(calendarData);
        localStorage.setItem(DATA_KEYS.PROGRAMS, JSON.stringify(allPrograms));
        console.log(`å·²å„²å­˜ ${allPrograms.length} å€‹ç¯€ç›®è³‡æ–™`);
        return allPrograms;
      } catch (error) {
        console.error('å„²å­˜ç¯€ç›®è³‡æ–™å¤±æ•—:', error);
        return [];
      }
    }
    
    // åŒæ­¥è³‡æ–™åˆ°å…¶ä»–ç³»çµ±
    function syncDataToOtherSystems() {
      const allPrograms = saveAllPrograms();
      
      // è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç³»çµ±è³‡æ–™å·²æ›´æ–°
      const event = new CustomEvent('programsDataUpdated', {
        detail: { programs: allPrograms }
      });
      window.dispatchEvent(event);
      
      console.log('è³‡æ–™å·²åŒæ­¥åˆ°å…¶ä»–ç³»çµ±');
    }
    
    // Contentful è¨­å®š
    const contentfulClient = contentful.createClient({
      space: 'os5wf90ljenp',
      accessToken: 'YOUR_DELIVERY_TOKEN'
    });
    
    // ç¯€ç›®ç¯„æœ¬
    const templates = [
      {
        id: 'morning',
        title: 'æ—©å®‰ä¸–ç•Œ',
        duration: 60,
        category: 'äºæ´²æ—…éŠ',
        description: 'è·Ÿè‘—æˆ‘å€‘ä¸€èµ·æ¢ç´¢{åœ°é»}çš„æ—©æ™¨ï¼Œå¾ç•¶åœ°å¸‚å ´åˆ°è‘—åæ™¯é»çš„å¯§éœæ™‚å…‰',
        status: 'é¦–æ’­',
        color: '#4caf50'
      },
      {
        id: 'kitchen',
        title: 'ä¸–ç•Œå»šæˆ¿',
        duration: 45,
        category: 'ç¾é£Ÿæ—…éŠ',
        description: 'æ·±å…¥{åœ°é»}ï¼Œå“åšæœ€é“åœ°çš„ç•¶åœ°ç¾é£Ÿèˆ‡ç‰¹è‰²æ–™ç†',
        status: 'é‡æ’­',
        color: '#ff9800'
      },
      {
        id: 'adventure',
        title: 'æ¥µåœ°æ¢éšª',
        duration: 60,
        category: 'æ¥µåœ°æ—…éŠ',
        description: 'åœ¨{åœ°é»}è¿½å°‹æ¥µå…‰çš„ç¥ç§˜è¹¤è·¡ï¼Œé«”é©—æ¥µåœ°æ¢éšªçš„åˆºæ¿€',
        status: 'ç‰¹åˆ¥ç¯€ç›®',
        color: '#2196f3'
      },
      {
        id: 'city',
        title: 'åŸå¸‚æ¼«æ­¥',
        duration: 45,
        category: 'æ­æ´²æ—…éŠ',
        description: 'æ²¿è‘—{åœ°é»}çš„è¡—é“æ¼«æ­¥ï¼Œæ„Ÿå—é€™åº§åŸå¸‚çš„ç¨ç‰¹é­…åŠ›',
        status: 'é‡æ’­',
        color: '#9c27b0'
      },
      {
        id: 'nature',
        title: 'è‡ªç„¶å¥‡è§€',
        duration: 60,
        category: 'è‡ªç„¶æ—…éŠ',
        description: 'æ¢ç´¢{åœ°é»}çš„è‡ªç„¶å¥‡è§€ï¼Œæ„Ÿå—å¤§è‡ªç„¶çš„å£¯éº—æ™¯è‰²',
        status: 'é¦–æ’­',
        color: '#8bc34a'
      }
    ];
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹
      currentUser = checkAuth();
      if (!currentUser) return;
      
      // æ›´æ–°é é¢æ¨™é¡Œé¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
      updateUserInfo();
      
              // è¼‰å…¥çµ±ä¸€è³‡æ–™
        loadAllPrograms();
        
        loadTemplates();
        
        // åˆå§‹åŒ–æ™‚é–“é¡¯ç¤º
        updateCurrentTime();
        
        // æ¯ç§’æ›´æ–°æ™‚é–“é¡¯ç¤º
        setInterval(updateCurrentTime, 1000);
      renderCalendar();
      loadFromContentful();
      updateStats();
    });
    
    // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
    function updateUserInfo() {
      const header = document.querySelector('.header h1');
      if (header && currentUser) {
        header.innerHTML = `ğŸ“… æœˆæ›†ç¯€ç›®ç®¡ç†ç³»çµ± <span style="font-size: 0.8rem; color: #666; font-weight: normal;">- ${currentUser.name} (${currentUser.role}) | <span style="color: #2b71d2;">v1.2.0 (2025/08/28 10:35:00)</span></span>`;
      }
    }
    
    // è¼‰å…¥ç¯„æœ¬
    function loadTemplates() {
      const grid = document.getElementById('templateGrid');
      grid.innerHTML = templates.map(template => `
        <div class="template-card" onclick="selectTemplate('${template.id}')" data-template="${template.id}">
          <h4>${template.title}</h4>
          <p>${template.duration}åˆ†é˜ | ${template.category}</p>
          <p>${template.description.substring(0, 50)}...</p>
        </div>
      `).join('');
    }
    
    // é¸æ“‡ç¯„æœ¬
    function selectTemplate(templateId) {
      // ç§»é™¤ä¹‹å‰çš„é¸æ“‡
      document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // é¸æ“‡æ–°çš„ç¯„æœ¬
      const card = document.querySelector(`[data-template="${templateId}"]`);
      if (card) {
        card.classList.add('selected');
        selectedTemplate = templates.find(t => t.id === templateId);
        showStatus('ç¯„æœ¬å·²é¸æ“‡ï¼Œé»æ“Šæœˆæ›†ä¸­çš„ç©ºç™½æ™‚æ®µä¾†æ·»åŠ ç¯€ç›®', 'info');
      }
    }
    
    // æ¸²æŸ“æœˆæ›†
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // æ›´æ–°æ¨™é¡Œ
      document.getElementById('currentMonth').textContent = `${year}å¹´${month + 1}æœˆ`;
      
      // è¨ˆç®—æœˆæ›†æ•¸æ“š
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      // ä¿®æ­£ï¼šJavaScript ä¸­ getDay() è¿”å› 0-6ï¼Œ0 æ˜¯æ˜ŸæœŸæ—¥
      // æ‰€ä»¥éœ€è¦èª¿æ•´è¨ˆç®—é‚è¼¯ï¼Œç¢ºä¿æœˆæ›†å¾æ˜ŸæœŸæ—¥é–‹å§‹
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      
      const calendarBody = document.getElementById('calendarBody');
      calendarBody.innerHTML = '';
      
      // ç”Ÿæˆ6é€±çš„æœˆæ›†
      for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(startDate);
          currentDay.setDate(startDate.getDate() + week * 7 + day);
          
          const isCurrentMonth = currentDay.getMonth() === month;
          const isToday = currentDay.toDateString() === new Date().toDateString();
          const dateString = currentDay.toISOString().split('T')[0];
          
          // æª¢æŸ¥æ˜¯å¦ç‚ºéå»çš„æ—¥æœŸï¼ˆæ—¥æœŸåœ¨ä»Šå¤©ä¹‹å‰ï¼‰
          const today = new Date();
          today.setHours(0, 0, 0, 0); // è¨­å®šç‚ºä»Šå¤©çš„é–‹å§‹æ™‚é–“
          const isPastDate = currentDay < today;
          
          const dayElement = document.createElement('div');
          dayElement.className = `calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
          dayElement.setAttribute('data-date', dateString);
          
          // å¦‚æœæ˜¯éå»çš„æ—¥æœŸï¼Œå®Œå…¨éš±è—
          if (isPastDate) {
            dayElement.style.display = 'none';
          } else {
             dayElement.innerHTML = `
               <div class="day-number">${currentDay.getMonth() + 1}/${currentDay.getDate()}</div>
               <div class="day-programs" id="programs-${dateString}">
                 ${generateTimeSlots(dateString)}
               </div>
             `;
           }
          
          calendarBody.appendChild(dayElement);
        }
      }
      
      // æ·»åŠ é»æ“Šäº‹ä»¶
      addCalendarClickEvents();
    }
    
                   // ç”Ÿæˆæ™‚é–“æ§½ - æ–°çš„æ™‚æ®µè¨­è¨ˆ
      function generateTimeSlots(dateString) {
        // ç²å–ç•¶å‰æ™‚é–“
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = currentHour * 60 + currentMinute; // è½‰æ›ç‚ºåˆ†é˜
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
        const today = new Date().toISOString().split('T')[0];
        const isToday = dateString === today;
        
        const timeSlots = [
          // 00:00-06:00 æ™‚æ®µ (12å€‹ç¯€ç›®ï¼Œæ¯30åˆ†é˜ä¸€å€‹)
          { time: '00:00', label: '00:00', period: '00:00-06:00', slot: 1 },
          { time: '00:30', label: '00:30', period: '00:00-06:00', slot: 2 },
          { time: '01:00', label: '01:00', period: '00:00-06:00', slot: 3 },
          { time: '01:30', label: '01:30', period: '00:00-06:00', slot: 4 },
          { time: '02:00', label: '02:00', period: '00:00-06:00', slot: 5 },
          { time: '02:30', label: '02:30', period: '00:00-06:00', slot: 6 },
          { time: '03:00', label: '03:00', period: '00:00-06:00', slot: 7 },
          { time: '03:30', label: '03:30', period: '00:00-06:00', slot: 8 },
          { time: '04:00', label: '04:00', period: '00:00-06:00', slot: 9 },
          { time: '04:30', label: '04:30', period: '00:00-06:00', slot: 10 },
          { time: '05:00', label: '05:00', period: '00:00-06:00', slot: 11 },
          { time: '05:30', label: '05:30', period: '00:00-06:00', slot: 12 },
          
          // 06:00-12:00 æ™‚æ®µ (12å€‹ç¯€ç›®ï¼Œæ¯30åˆ†é˜ä¸€å€‹)
          { time: '06:00', label: '06:00', period: '06:00-12:00', slot: 1 },
          { time: '06:30', label: '06:30', period: '06:00-12:00', slot: 2 },
          { time: '07:00', label: '07:00', period: '06:00-12:00', slot: 3 },
          { time: '07:30', label: '07:30', period: '06:00-12:00', slot: 4 },
          { time: '08:00', label: '08:00', period: '06:00-12:00', slot: 5 },
          { time: '08:30', label: '08:30', period: '06:00-12:00', slot: 6 },
          { time: '09:00', label: '09:00', period: '06:00-12:00', slot: 7 },
          { time: '09:30', label: '09:30', period: '06:00-12:00', slot: 8 },
          { time: '10:00', label: '10:00', period: '06:00-12:00', slot: 9 },
          { time: '10:30', label: '10:30', period: '06:00-12:00', slot: 10 },
          { time: '11:00', label: '11:00', period: '06:00-12:00', slot: 11 },
          { time: '11:30', label: '11:30', period: '06:00-12:00', slot: 12 },
          
          // 12:00-18:00 æ™‚æ®µ (12å€‹ç¯€ç›®ï¼Œæ¯30åˆ†é˜ä¸€å€‹) - é¦–æ’­æ”¾ç½®å€
          { time: '12:00', label: '12:00', period: '12:00-18:00', slot: 1, isPrimeTime: true },
          { time: '12:30', label: '12:30', period: '12:00-18:00', slot: 2, isPrimeTime: true },
          { time: '13:00', label: '13:00', period: '12:00-18:00', slot: 3, isPrimeTime: true },
          { time: '13:30', label: '13:30', period: '12:00-18:00', slot: 4, isPrimeTime: true },
          { time: '14:00', label: '14:00', period: '12:00-18:00', slot: 5, isPrimeTime: true },
          { time: '14:30', label: '14:30', period: '12:00-18:00', slot: 6, isPrimeTime: true },
          { time: '15:00', label: '15:00', period: '12:00-18:00', slot: 7, isPrimeTime: true },
          { time: '15:30', label: '15:30', period: '12:00-18:00', slot: 8, isPrimeTime: true },
          { time: '16:00', label: '16:00', period: '12:00-18:00', slot: 9, isPrimeTime: true },
          { time: '16:30', label: '16:30', period: '12:00-18:00', slot: 10, isPrimeTime: true },
          { time: '17:00', label: '17:00', period: '12:00-18:00', slot: 11, isPrimeTime: true },
          { time: '17:30', label: '17:30', period: '12:00-18:00', slot: 12, isPrimeTime: true },
          
          // 18:00-24:00 æ™‚æ®µ (12å€‹ç¯€ç›®ï¼Œæ¯30åˆ†é˜ä¸€å€‹)
          { time: '18:00', label: '18:00', period: '18:00-24:00', slot: 1 },
          { time: '18:30', label: '18:30', period: '18:00-24:00', slot: 2 },
          { time: '19:00', label: '19:00', period: '18:00-24:00', slot: 3 },
          { time: '19:30', label: '19:30', period: '18:00-24:00', slot: 4 },
          { time: '20:00', label: '20:00', period: '18:00-24:00', slot: 5 },
          { time: '20:30', label: '20:30', period: '18:00-24:00', slot: 6 },
          { time: '21:00', label: '21:00', period: '18:00-24:00', slot: 7 },
          { time: '21:30', label: '21:30', period: '18:00-24:00', slot: 8 },
          { time: '22:00', label: '22:00', period: '18:00-24:00', slot: 9 },
          { time: '22:30', label: '22:30', period: '18:00-24:00', slot: 10 },
          { time: '23:00', label: '23:00', period: '18:00-24:00', slot: 11 },
          { time: '23:30', label: '23:30', period: '18:00-24:00', slot: 12 }
        ];
        
                 // éæ¿¾å·²éå»çš„æ™‚é–“ï¼ˆåƒ…å°ä»Šå¤©ï¼‰
         const filteredTimeSlots = timeSlots.filter(slot => {
           if (!isToday) return true; // éä»Šå¤©é¡¯ç¤ºæ‰€æœ‰æ™‚é–“
           
           // å°‡æ™‚é–“è½‰æ›ç‚ºåˆ†é˜é€²è¡Œæ¯”è¼ƒ
           const [hour, minute] = slot.time.split(':').map(Number);
           const slotTime = hour * 60 + minute;
           
           // å‹•æ…‹éæ¿¾ï¼šéš±è—ç•¶å‰æ™‚é–“ä¹‹å‰çš„æ™‚é–“æ®µ
           // ä¾‹å¦‚ï¼šç¾åœ¨æ˜¯æ™šä¸Š9é»24åˆ†ï¼Œéš±è—æ™šä¸Š9é»åŠä¹‹å‰çš„æ™‚é–“
           // ä½†ä¿ç•™ä¸€äº›ç·©è¡æ™‚é–“ï¼Œé¿å…éåº¦éæ¿¾
           const shouldShow = slotTime >= (currentTime - 120); // ä¿ç•™120åˆ†é˜ç·©è¡
           
           // èª¿è©¦ä¿¡æ¯
           if (isToday && !shouldShow) {
             console.log(`éš±è—æ™‚é–“æ§½: ${slot.time} (${slotTime}åˆ†é˜) < ç•¶å‰æ™‚é–“ (${currentTime}åˆ†é˜)`);
           }
           
           return shouldShow;
         });
      
                              // æŒ‰æ™‚æ®µåˆ†çµ„
         const periodGroups = {
           '00:00-06:00': [],
           '06:00-12:00': [],
           '12:00-18:00': [],
           '18:00-24:00': []
         };
         
         filteredTimeSlots.forEach(slot => {
          const slotKey = `${dateString}-${slot.time}`;
          const program = calendarData[slotKey];
          
          const slotHtml = program ? 
            `<div class="program-slot ${slot.isPrimeTime ? 'prime-time' : ''}" data-slot="${slotKey}" style="background-color: ${program.color || '#e8f5e8'}">
              <div class="slot-time">${slot.label}</div>
              <div class="program-title">${program.title}</div>
              ${program.status === 'é¦–æ’­' ? '<div class="first-air-badge">é¦–æ’­</div>' : ''}
            </div>` :
            `<div class="program-slot empty ${slot.isPrimeTime ? 'prime-time' : ''}" data-slot="${slotKey}">
              <div class="slot-time">${slot.label}</div>
              <div class="slot-status">ç©ºç™½</div>
            </div>`;
          
          periodGroups[slot.period].push(slotHtml);
        });
        
                 // ç”Ÿæˆåˆ†çµ„å¾Œçš„HTMLï¼Œåªé¡¯ç¤ºæœ‰æ™‚é–“æ§½çš„æ™‚æ®µ
         return Object.entries(periodGroups)
           .filter(([period, slots]) => slots.length > 0) // åªé¡¯ç¤ºæœ‰æ™‚é–“æ§½çš„æ™‚æ®µ
           .map(([period, slots]) => `
             <div class="period-group" data-period="${period}">
               <div class="period-header ${period === '12:00-18:00' ? 'prime-time-header' : ''}">
                 ${period} ${period === '12:00-18:00' ? 'ğŸŒŸ é¦–æ’­æ”¾ç½®å€' : ''}
               </div>
               <div class="period-slots">
                 ${slots.join('')}
               </div>
             </div>
           `).join('');
    }
    
    // æ·»åŠ æœˆæ›†é»æ“Šäº‹ä»¶
    function addCalendarClickEvents() {
      document.querySelectorAll('.program-slot').forEach(slot => {
        slot.addEventListener('click', function() {
          const slotKey = this.getAttribute('data-slot');
          const [date, time] = slotKey.split('-');
          
          if (this.classList.contains('empty')) {
            // ç©ºç™½æ™‚æ®µ - æ·»åŠ æ–°ç¯€ç›®
            if (selectedTemplate) {
              addProgramFromTemplate(date, time);
            } else {
              openProgramModal(date, time);
            }
          } else {
            // å·²æœ‰ç¯€ç›® - ç·¨è¼¯
            openProgramModal(date, time, calendarData[slotKey]);
          }
        });
      });
    }
    
    // å¾ç¯„æœ¬æ·»åŠ ç¯€ç›®
    function addProgramFromTemplate(date, time) {
      const program = {
        ...selectedTemplate,
        title: selectedTemplate.title.replace('{åœ°é»}', 'æ—¥æœ¬æ±äº¬'), // å¯ä»¥è®“ç”¨æˆ¶é¸æ“‡åœ°é»
        airDate: date,
        airTime: time,
        color: selectedTemplate.color
      };
      
      const slotKey = `${date}-${time}`;
      calendarData[slotKey] = program;
      
      updateProgramSlot(slotKey, program);
      updateStats();
      showStatus(`å·²æ·»åŠ ç¯€ç›®ï¼š${program.title}`, 'success');
    }
    
         // æ‰“é–‹ç¯€ç›®ç·¨è¼¯æ¨¡æ…‹æ¡†
     function openProgramModal(date, time, program = null) {
       document.getElementById('editDate').value = date;
       document.getElementById('editTime').value = time;
       document.getElementById('airTime').value = time;
       
       if (program) {
         // ç·¨è¼¯ç¾æœ‰ç¯€ç›®
         document.getElementById('modalTitle').textContent = 'ç·¨è¼¯ç¯€ç›®';
         document.getElementById('title').value = program.title;
         document.getElementById('duration').value = program.duration;
         document.getElementById('category').value = program.category;
         document.getElementById('description').value = program.description;
         document.getElementById('youtubeId').value = program.youtubeId || '';
         document.getElementById('status').value = program.status;
         
         // è¨­å®šå½±ç‰‡é¡å‹ä¸¦åˆ‡æ›è¼¸å…¥æ¬„ä½
         if (program.videoType) {
           document.getElementById('videoType').value = program.videoType;
           toggleVideoInput();
         }
       } else {
         // æ–°å¢ç¯€ç›®
         document.getElementById('modalTitle').textContent = 'æ–°å¢ç¯€ç›®';
         document.getElementById('programForm').reset();
         document.getElementById('airTime').value = time; // è‡ªå‹•å¸¶å‡ºé¸å®šçš„æ™‚é–“
       }
       
       document.getElementById('programModal').style.display = 'block';
     }
    
    // é—œé–‰æ¨¡æ…‹æ¡†
    function closeModal() {
      document.getElementById('programModal').style.display = 'none';
    }
    
    // å„²å­˜ç¯€ç›®
    document.getElementById('programForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!checkPermission('write')) {
        showStatus('æ‚¨æ²’æœ‰ç·¨è¼¯ç¯€ç›®çš„æ¬Šé™', 'error');
        return;
      }
      
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('airTime').value;
      const slotKey = `${date}-${time}`;
      
             const videoType = document.getElementById('videoType').value;
       const videoId = videoType === 'YouTube' 
         ? document.getElementById('youtubeId').value 
         : document.getElementById('mp4Url').value;
       
       const program = {
         airDate: date,
         airTime: time,
         title: document.getElementById('title').value,
         duration: parseInt(document.getElementById('duration').value),
         category: document.getElementById('category').value,
         description: document.getElementById('description').value,
         videoType: videoType,
         videoId: videoId,
         status: document.getElementById('status').value,
         color: '#e8f5e8',
         createdBy: currentUser.email,
         createdAt: new Date().toISOString()
       };
      
      calendarData[slotKey] = program;
      updateProgramSlot(slotKey, program);
      updateStats();
      
      // åŒæ­¥è³‡æ–™åˆ°å…¶ä»–ç³»çµ±
      syncDataToOtherSystems();
      
      closeModal();
      showStatus('ç¯€ç›®å·²å„²å­˜ä¸¦åŒæ­¥åˆ°å…¶ä»–ç³»çµ±', 'success');
    });
    
    // æª¢æŸ¥ç”¨æˆ¶æ¬Šé™
    function checkPermission(permission) {
      if (!currentUser) return false;
      
      // Super Admin æ“æœ‰æ‰€æœ‰æ¬Šé™
      if (currentUser.role === 'super_admin') return true;
      
      // æª¢æŸ¥ç‰¹å®šæ¬Šé™
      if (currentUser.permissions.includes('all')) return true;
      
      return currentUser.permissions.includes(permission);
    }
    
    // åˆªé™¤ç¯€ç›®
    function deleteProgram() {
      if (!checkPermission('delete')) {
        showStatus('æ‚¨æ²’æœ‰åˆªé™¤ç¯€ç›®çš„æ¬Šé™', 'error');
        return;
      }
      
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('editTime').value;
      const slotKey = `${date}-${time}`;
      
      delete calendarData[slotKey];
      updateProgramSlot(slotKey, null);
      updateStats();
      
      // åŒæ­¥è³‡æ–™åˆ°å…¶ä»–ç³»çµ±
      syncDataToOtherSystems();
      
      closeModal();
      showStatus('ç¯€ç›®å·²åˆªé™¤ä¸¦åŒæ­¥åˆ°å…¶ä»–ç³»çµ±', 'success');
    }
    
    // æ›´æ–°ç¯€ç›®æ§½
    function updateProgramSlot(slotKey, program) {
      const slotElement = document.querySelector(`[data-slot="${slotKey}"]`);
      if (slotElement) {
        if (program) {
          slotElement.className = 'program-slot';
          slotElement.style.backgroundColor = program.color || '#e8f5e8';
          slotElement.textContent = program.title;
        } else {
          const [date, time] = slotKey.split('-');
          slotElement.className = 'program-slot empty';
          slotElement.style.backgroundColor = '';
          slotElement.textContent = `${time} - ç©ºç™½`;
        }
      }
    }
    
               // æ›´æ–°çµ±è¨ˆ
      function updateStats() {
        const totalSlots = Object.keys(calendarData).length;
        const totalDays = 31; // ç°¡åŒ–è¨ˆç®—
        const totalTimeSlots = totalDays * 48; // 48å€‹æ™‚æ®µ (4å€‹æ™‚æ®µ Ã— 12å€‹ç¯€ç›®)
        const emptySlots = totalTimeSlots - totalSlots;
        const coverageRate = Math.round((totalSlots / totalTimeSlots) * 100);
        
        // è¨ˆç®—é¦–æ’­ç¯€ç›®æ•¸é‡
        const firstAirPrograms = Object.values(calendarData).filter(p => p.status === 'é¦–æ’­').length;
        
        document.getElementById('totalPrograms').textContent = totalSlots;
        document.getElementById('emptySlots').textContent = emptySlots;
        document.getElementById('coverageRate').textContent = `${coverageRate}%`;
        
        // æ·»åŠ é¦–æ’­ç¯€ç›®çµ±è¨ˆ
        const statsContainer = document.querySelector('.stats');
        if (!document.getElementById('firstAirPrograms')) {
          const firstAirStat = document.createElement('div');
          firstAirStat.className = 'stat-item';
          firstAirStat.innerHTML = `
            <div class="stat-number" id="firstAirPrograms">0</div>
            <div class="stat-label">é¦–æ’­ç¯€ç›®</div>
          `;
          statsContainer.appendChild(firstAirStat);
        }
        document.getElementById('firstAirPrograms').textContent = firstAirPrograms;
      }
      
      // æ›´æ–°ç•¶å‰æ™‚é–“é¡¯ç¤º
      function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = `ğŸ• ç•¶å‰æ™‚é–“: ${timeString}`;
        }
      }
    
    // æœˆæ›†å°èˆª
    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }
    
    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }
    
    // è‡ªå‹•å¡«å……åŠŸèƒ½
    function showAutoFillPanel() {
      const panel = document.getElementById('autoFillPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    function autoFillEmptySlots() {
      // æ‰¾åˆ°æ‰€æœ‰ç©ºç™½æ™‚æ®µä¸¦è‡ªå‹•å¡«å……
      const emptySlots = document.querySelectorAll('.program-slot.empty');
      let filledCount = 0;
      
      emptySlots.forEach((slot, index) => {
        const slotKey = slot.getAttribute('data-slot');
        const [date, time] = slotKey.split('-');
        
        // ä½¿ç”¨å¾ªç’°çš„ç¯„æœ¬
        const template = templates[index % templates.length];
        const program = {
          ...template,
          title: template.title.replace('{åœ°é»}', 'è‡ªå‹•å¡«å……'),
          airDate: date,
          airTime: time,
          color: template.color
        };
        
        calendarData[slotKey] = program;
        updateProgramSlot(slotKey, program);
        filledCount++;
      });
      
      updateStats();
      showStatus(`å·²è‡ªå‹•å¡«å…… ${filledCount} å€‹ç©ºç™½æ™‚æ®µ`, 'success');
    }
    
    function generateWeeklyPattern() {
      // ç”Ÿæˆé€±æœŸæ¨¡å¼
      const weekPattern = [
        { template: templates[0], day: 1 }, // é€±ä¸€ï¼šæ—©å®‰ä¸–ç•Œ
        { template: templates[1], day: 2 }, // é€±äºŒï¼šä¸–ç•Œå»šæˆ¿
        { template: templates[2], day: 3 }, // é€±ä¸‰ï¼šæ¥µåœ°æ¢éšª
        { template: templates[3], day: 4 }, // é€±å››ï¼šåŸå¸‚æ¼«æ­¥
        { template: templates[4], day: 5 }, // é€±äº”ï¼šè‡ªç„¶å¥‡è§€
        { template: templates[0], day: 6 }, // é€±å…­ï¼šæ—©å®‰ä¸–ç•Œ
        { template: templates[1], day: 0 }  // é€±æ—¥ï¼šä¸–ç•Œå»šæˆ¿
      ];
      
      // æ¸…ç©ºç¾æœ‰æ•¸æ“š
      calendarData = {};
      
      // ç”Ÿæˆæ•´å€‹æœˆçš„é€±æœŸæ¨¡å¼
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();
        const pattern = weekPattern.find(p => p.day === dayOfWeek);
        
        if (pattern) {
          const dateString = date.toISOString().split('T')[0];
          const timeSlots = ['06:00', '12:00', '18:00']; // ä¸»è¦æ™‚æ®µ
          
          timeSlots.forEach(time => {
            const slotKey = `${dateString}-${time}`;
            const program = {
              ...pattern.template,
              title: pattern.template.title.replace('{åœ°é»}', 'é€±æœŸå®‰æ’'),
              airDate: dateString,
              airTime: time,
              color: pattern.template.color
            };
            
            calendarData[slotKey] = program;
          });
        }
      }
      
      renderCalendar();
      updateStats();
      showStatus('å·²ç”Ÿæˆé€±æœŸç¯€ç›®æ¨¡å¼', 'success');
    }
    
         // Contentful æ•´åˆ - è¼‰å…¥ç¯€ç›®è³‡æ–™
     async function loadFromContentful() {
       try {
         const year = currentDate.getFullYear();
         const month = currentDate.getMonth() + 1;
         const monthString = month.toString().padStart(2, '0');
         
         console.log('æ­£åœ¨è¼‰å…¥ Contentful è³‡æ–™ï¼Œæœˆä»½:', `${year}-${monthString}`);
         
         // å˜—è©¦è¼‰å…¥ç¯€ç›®è¡¨è³‡æ–™ (æ”¯æ´å¤šç¨®å…§å®¹é¡å‹)
         let scheduleResponse = null;
         let programsResponse = null;
         
         // æ–¹æ³•1ï¼šå˜—è©¦è¼‰å…¥ scheduleItem
         try {
           scheduleResponse = await contentfulClient.getEntries({
             content_type: 'scheduleItem',
             'fields.airDate[gte]': `${year}-${monthString}-01`,
             'fields.airDate[lt]': `${year}-${monthString}-32`,
             include: 2
           });
           console.log('æˆåŠŸè¼‰å…¥ scheduleItem è³‡æ–™:', scheduleResponse.items?.length || 0, 'å€‹é …ç›®');
         } catch (error) {
           console.log('scheduleItem è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–å…§å®¹é¡å‹:', error.message);
         }
         
         // æ–¹æ³•2ï¼šå¦‚æœ scheduleItem å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥ monthlySchedule
         if (!scheduleResponse || !scheduleResponse.items || scheduleResponse.items.length === 0) {
           try {
             const monthlyResponse = await contentfulClient.getEntries({
               content_type: 'monthlySchedule',
               'fields.monthYear': `${year}-${monthString}`,
               include: 2
             });
             
             if (monthlyResponse.items && monthlyResponse.items.length > 0) {
               const monthlySchedule = monthlyResponse.items[0];
               const programs = monthlySchedule.fields.programs || [];
               
               // è½‰æ›ç‚º scheduleItem æ ¼å¼
               scheduleResponse = {
                 items: programs.map(program => ({
                   fields: {
                     airDate: program.fields.airDate,
                     airTime: program.fields.airTime,
                     title: program.fields.title,
                     duration: program.fields.duration,
                     category: program.fields.category,
                     description: program.fields.description,
                     videoType: program.fields.videoType,
                     videoId: program.fields.videoId,
                     status: program.fields.status,
                     thumbnail: program.fields.thumbnail
                   },
                   sys: { id: program.sys?.id || 'temp-' + Date.now() }
                 }))
               };
               console.log('æˆåŠŸè¼‰å…¥ monthlySchedule è³‡æ–™:', scheduleResponse.items.length, 'å€‹é …ç›®');
             }
           } catch (error) {
             console.log('monthlySchedule è¼‰å…¥å¤±æ•—:', error.message);
           }
         }
         
         // è¼‰å…¥ç¯€ç›®åº«è³‡æ–™ (ç”¨æ–¼é¦–æ’­ç¯€ç›®)
         try {
           programsResponse = await contentfulClient.getEntries({
             content_type: 'program',
             include: 2
           });
           console.log('æˆåŠŸè¼‰å…¥ç¯€ç›®åº«è³‡æ–™:', programsResponse.items?.length || 0, 'å€‹ç¯€ç›®');
         } catch (error) {
           console.log('ç¯€ç›®åº«è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–å…§å®¹é¡å‹:', error.message);
           
           // å˜—è©¦è¼‰å…¥ programTemplate
           try {
             programsResponse = await contentfulClient.getEntries({
               content_type: 'programTemplate',
               include: 2
             });
             console.log('æˆåŠŸè¼‰å…¥ programTemplate è³‡æ–™:', programsResponse.items?.length || 0, 'å€‹ç¯„æœ¬');
           } catch (error2) {
             console.log('programTemplate è¼‰å…¥ä¹Ÿå¤±æ•—:', error2.message);
           }
         }
         
         // è™•ç†ç¯€ç›®è¡¨è³‡æ–™
         if (scheduleResponse && scheduleResponse.items && scheduleResponse.items.length > 0) {
           scheduleResponse.items.forEach(item => {
             // çµ±ä¸€æ¬„ä½åç¨±è™•ç†
             const fields = item.fields || {};
             
             // æ—¥æœŸå’Œæ™‚é–“
             const date = fields.airDate || fields.æ’­å‡ºæ—¥æœŸ;
             const time = fields.airTime || fields.æ’­å‡ºæ™‚é–“;
             
             if (!date || !time) {
               console.warn('è·³éç„¡æ•ˆçš„ç¯€ç›®é …ç›®:', item);
               return;
             }
             
             const slotKey = `${date}-${time}`;
             
             calendarData[slotKey] = {
               airDate: date,
               airTime: time,
               title: fields.title || fields.ç¯€ç›®æ¨™é¡Œ || 'æœªå‘½åç¯€ç›®',
               duration: fields.duration || fields.ç¯€ç›®æ™‚é•· || 30,
               category: fields.category || fields.ç¯€ç›®åˆ†é¡ || 'æ—…éŠç¯€ç›®',
               description: fields.description || fields.ç¯€ç›®æè¿° || '',
               videoType: fields.videoType || 'YouTube',
               videoId: fields.videoId || fields.youtubeId || fields.YouTubeID || '',
               status: fields.status || fields.ç¯€ç›®ç‹€æ…‹ || 'é‡æ’­',
               thumbnail: fields.thumbnail || fields.ç¸®åœ– || '',
               color: fields.colorCode || '#e8f5e8',
               contentfulId: item.sys.id,
               createdBy: fields.createdBy || 'admin',
               createdAt: fields.createdAt || new Date().toISOString()
             };
             
             console.log('å·²è¼‰å…¥ç¯€ç›®:', calendarData[slotKey].title, 'æ™‚é–“:', time);
           });
         }
         
         // å„²å­˜ç¯€ç›®åº«è³‡æ–™åˆ°æœ¬åœ°
         if (programsResponse && programsResponse.items && programsResponse.items.length > 0) {
           const programs = programsResponse.items.map(item => {
             const fields = item.fields || {};
             
             return {
               id: item.sys.id,
               title: fields.title || fields.ç¯€ç›®æ¨™é¡Œ || fields.templateName || 'æœªå‘½åç¯€ç›®',
               duration: fields.duration || fields.ç¯€ç›®æ™‚é•· || 30,
               category: fields.category || fields.ç¯€ç›®åˆ†é¡ || 'æ—…éŠç¯€ç›®',
               description: fields.description || fields.ç¯€ç›®æè¿° || '',
               videoType: fields.videoType || 'YouTube',
               videoId: fields.videoId || fields.youtubeId || fields.YouTubeID || '',
               thumbnail: fields.thumbnail || fields.ç¸®åœ– || '',
               status: 'æœªæ’­å‡º',
               colorCode: fields.colorCode || '#e8f5e8',
               createdAt: item.sys.createdAt,
               updatedAt: item.sys.updatedAt
             };
           });
           
           localStorage.setItem('contentful_programs', JSON.stringify(programs));
           console.log(`å·²è¼‰å…¥ ${programs.length} å€‹ç¯€ç›®åº«è³‡æ–™`);
           
           // é¡¯ç¤ºè¼‰å…¥çš„ç¯€ç›®ç¯„ä¾‹
           if (programs.length > 0) {
             console.log('ç¯€ç›®åº«ç¯„ä¾‹:', programs[0]);
           }
         } else {
           console.log('æ²’æœ‰æ‰¾åˆ°ç¯€ç›®åº«è³‡æ–™');
         }
         
         renderCalendar();
         updateStats();
         showStatus(`å·²å¾ Contentful è¼‰å…¥ ${scheduleResponse.items?.length || 0} å€‹ç¯€ç›®è¡¨é …ç›®`, 'success');
         
       } catch (error) {
         console.log('Contentful è¼‰å…¥å¤±æ•—:', error);
         showStatus('Contentful è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š', 'warning');
       }
     }
    
    async function saveToContentful() {
      if (!checkPermission('publish')) {
        showStatus('æ‚¨æ²’æœ‰ç™¼å¸ƒåˆ° Contentful çš„æ¬Šé™', 'error');
        return;
      }
      
      try {
        showStatus('æ­£åœ¨å„²å­˜åˆ° Contentful...', 'info');
        
        const programs = Object.values(calendarData);
        let savedCount = 0;
        
        for (const program of programs) {
          try {
            // é€™è£¡æ‡‰è©²èª¿ç”¨ Contentful API ä¾†å‰µå»ºæˆ–æ›´æ–°ç¯€ç›®
            // ç”±æ–¼é€™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼Œæˆ‘å€‘åªè¨˜éŒ„åˆ°æ§åˆ¶å°
            console.log('å„²å­˜ç¯€ç›®:', program);
            savedCount++;
          } catch (error) {
            console.error('å„²å­˜ç¯€ç›®å¤±æ•—:', error);
          }
        }
        
        showStatus(`æˆåŠŸå„²å­˜ ${savedCount} å€‹ç¯€ç›®åˆ° Contentful`, 'success');
      } catch (error) {
        console.error('Contentful å„²å­˜å¤±æ•—:', error);
        showStatus('Contentful å„²å­˜å¤±æ•—', 'error');
      }
    }
    
    // åŒ¯å‡ºæœˆæ›†
    function exportCalendar() {
      const data = {
        month: currentDate.getFullYear() + '-' + (currentDate.getMonth() + 1),
        programs: Object.values(calendarData)
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `calendar-${data.month}.json`;
      a.click();
      
      showStatus('æœˆæ›†å·²åŒ¯å‡º', 'success');
    }
    
    // é¡¯ç¤ºç‹€æ…‹
    function showStatus(message, type) {
      const statusBar = document.getElementById('statusBar');
      const statusMessage = document.getElementById('statusMessage');
      
      statusMessage.textContent = message;
      statusBar.style.display = 'block';
      
      // æ ¹æ“šé¡å‹è¨­å®šé¡è‰²
      statusBar.style.backgroundColor = type === 'success' ? '#4caf50' : 
                                      type === 'error' ? '#f44336' : 
                                      type === 'warning' ? '#ff9800' : '#333';
      
      setTimeout(() => {
        statusBar.style.display = 'none';
      }, 3000);
    }
    
         // åˆ‡æ›å½±ç‰‡è¼¸å…¥æ¬„ä½
     function toggleVideoInput() {
       const videoType = document.getElementById('videoType').value;
       const youtubeGroup = document.getElementById('youtubeGroup');
       const mp4Group = document.getElementById('mp4Group');
       
       if (videoType === 'YouTube') {
         youtubeGroup.style.display = 'block';
         mp4Group.style.display = 'none';
       } else {
         youtubeGroup.style.display = 'none';
         mp4Group.style.display = 'block';
       }
     }
     
     // è‡ªå‹•ç²å– YouTube å½±ç‰‡æ¨™é¡Œ
     async function fetchYouTubeTitle(videoId) {
       try {
         showStatus('æ­£åœ¨ç²å– YouTube å½±ç‰‡è³‡è¨Š...', 'info');
         
         // ä½¿ç”¨ oEmbed API ç²å–å½±ç‰‡è³‡è¨Šï¼ˆä¸éœ€è¦ API Keyï¼‰
         const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
         
         if (!response.ok) {
           throw new Error('ç„¡æ³•ç²å– YouTube å½±ç‰‡è³‡è¨Š');
         }
         
         const data = await response.json();
         
         if (data.title) {
           // è‡ªå‹•å¡«å……æ¨™é¡Œ
           document.getElementById('title').value = data.title;
           
           // è‡ªå‹•ç”Ÿæˆç¸®åœ–
           const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
           document.getElementById('thumbnailImg').src = thumbnailUrl;
           document.getElementById('thumbnailPreview').style.display = 'block';
           
           showStatus('å·²è‡ªå‹•ç²å– YouTube å½±ç‰‡æ¨™é¡Œ', 'success');
         } else {
           showStatus('æ‰¾ä¸åˆ°è©² YouTube å½±ç‰‡', 'error');
         }
       } catch (error) {
         console.error('ç²å– YouTube æ¨™é¡Œå¤±æ•—:', error);
         showStatus('ç„¡æ³•ç²å– YouTube å½±ç‰‡è³‡è¨Šï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ¨™é¡Œ', 'warning');
       }
     }
    
    // æª”æ¡ˆä¸Šå‚³è™•ç†
    document.getElementById('mp4File').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // æª¢æŸ¥æª”æ¡ˆå¤§å° (500MB é™åˆ¶)
        if (file.size > 500 * 1024 * 1024) {
          alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 500MB');
          this.value = '';
          return;
        }
        
        // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        document.getElementById('fileInfo').style.display = 'block';
        
        // æ¨¡æ“¬ä¸Šå‚³é€²åº¦
        simulateUpload();
      }
    });
    
    // æ¨¡æ“¬ä¸Šå‚³é€²åº¦
    function simulateUpload() {
      const progressBar = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const uploadProgress = document.getElementById('uploadProgress');
      
      uploadProgress.style.display = 'block';
      let progress = 0;
      
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          setTimeout(() => {
            uploadProgress.style.display = 'none';
            showStatus('å½±ç‰‡ä¸Šå‚³å®Œæˆï¼', 'success');
          }, 500);
        }
        
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
      }, 200);
    }
    
    // ç¸®åœ–ä¸Šå‚³è™•ç†
    document.getElementById('thumbnailFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('thumbnailImg').src = e.target.result;
          document.getElementById('thumbnailPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
    
    // ç§»é™¤ç¸®åœ–
    function removeThumbnail() {
      document.getElementById('thumbnailFile').value = '';
      document.getElementById('thumbnailPreview').style.display = 'none';
    }
    
         // è‡ªå‹•ç”Ÿæˆç¸®åœ–
     function generateAutoThumbnail() {
       const videoType = document.getElementById('videoType').value;
       const videoId = document.getElementById('youtubeId').value;
       
       if (videoType === 'YouTube' && videoId) {
         // ä½¿ç”¨ YouTube ç¸®åœ–
         const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
         document.getElementById('thumbnailImg').src = thumbnailUrl;
         document.getElementById('thumbnailPreview').style.display = 'block';
         showStatus('å·²è‡ªå‹•ç”Ÿæˆ YouTube ç¸®åœ–', 'success');
       } else {
         showStatus('è«‹å…ˆé¸æ“‡ YouTube å½±ç‰‡ä¸¦è¼¸å…¥ ID', 'error');
       }
     }
     
     // åˆ‡æ›ç¯€ç›®é¸æ“‡
     function toggleProgramSelection() {
       const status = document.getElementById('status').value;
       const programSelectionGroup = document.getElementById('programSelectionGroup');
       
       if (status === 'é¦–æ’­') {
         programSelectionGroup.style.display = 'block';
         loadProgramLibrary();
       } else {
         programSelectionGroup.style.display = 'none';
       }
     }
     
     // è¼‰å…¥ç¯€ç›®åº«
     function loadProgramLibrary() {
       const savedPrograms = localStorage.getItem('contentful_programs');
       const programSelection = document.getElementById('programSelection');
       
       if (savedPrograms) {
         const programs = JSON.parse(savedPrograms);
         const unairedPrograms = programs.filter(p => p.status === 'æœªæ’­å‡º');
         
         programSelection.innerHTML = '<option value="">-- å¾ç¯€ç›®åº«é¸æ“‡ --</option>';
         
         unairedPrograms.forEach(program => {
           const option = document.createElement('option');
           option.value = program.id;
           option.textContent = `${program.title} (${program.category}) - ${program.duration}åˆ†é˜`;
           programSelection.appendChild(option);
         });
         
         if (unairedPrograms.length === 0) {
           programSelection.innerHTML = '<option value="">-- æ²’æœ‰å¯ç”¨çš„é¦–æ’­ç¯€ç›® --</option>';
         }
       } else {
         programSelection.innerHTML = '<option value="">-- è«‹å…ˆè¼‰å…¥ç¯€ç›®åº« --</option>';
       }
     }
     
     // é¸æ“‡ç¯€ç›®åº«ç¯€ç›®
     document.getElementById('programSelection').addEventListener('change', function() {
       const selectedId = this.value;
       if (selectedId) {
         const savedPrograms = localStorage.getItem('contentful_programs');
         if (savedPrograms) {
           const programs = JSON.parse(savedPrograms);
           const selectedProgram = programs.find(p => p.id === selectedId);
           
           if (selectedProgram) {
             // è‡ªå‹•å¡«å……ç¯€ç›®è³‡è¨Š
             document.getElementById('title').value = selectedProgram.title;
             document.getElementById('duration').value = selectedProgram.duration;
             document.getElementById('category').value = selectedProgram.category;
             document.getElementById('description').value = selectedProgram.description;
             document.getElementById('videoType').value = selectedProgram.videoType;
             
             if (selectedProgram.videoType === 'YouTube') {
               document.getElementById('youtubeId').value = selectedProgram.videoId;
               toggleVideoInput();
             }
             
             if (selectedProgram.thumbnail) {
               document.getElementById('thumbnailImg').src = selectedProgram.thumbnail;
               document.getElementById('thumbnailPreview').style.display = 'block';
             }
             
             showStatus('å·²è¼‰å…¥ç¯€ç›®è³‡è¨Š', 'success');
           }
         }
       }
     });
     
     // YouTube ID è¼¸å…¥æ¡†äº‹ä»¶ç›£è½å™¨ - è‡ªå‹•ç²å–æ¨™é¡Œ
     document.getElementById('youtubeId').addEventListener('blur', function() {
       const videoId = this.value.trim();
       if (videoId && videoId.length >= 11) {
         // å»¶é² 1 ç§’å¾Œè‡ªå‹•ç²å–æ¨™é¡Œï¼Œé¿å…ç”¨æˆ¶é‚„åœ¨è¼¸å…¥
         setTimeout(() => {
           if (this.value === videoId) { // ç¢ºèªç”¨æˆ¶æ²’æœ‰ç¹¼çºŒä¿®æ”¹
             fetchYouTubeTitle(videoId);
           }
         }, 1000);
       }
     });
     
     // æ·»åŠ ä¸€å€‹æ‰‹å‹•ç²å–æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
     document.addEventListener('DOMContentLoaded', function() {
       // åœ¨ YouTube ID è¼¸å…¥æ¡†æ—é‚Šæ·»åŠ ä¸€å€‹ç²å–æŒ‰éˆ•
       const youtubeGroup = document.getElementById('youtubeGroup');
       
       // å‰µå»ºç²å–æŒ‰éˆ•
       const fetchButton = document.createElement('button');
       fetchButton.type = 'button';
       fetchButton.className = 'btn btn-secondary';
       fetchButton.style.marginLeft = '10px';
       fetchButton.style.marginTop = '5px';
       fetchButton.style.fontSize = '12px';
       fetchButton.style.padding = '8px 12px';
       fetchButton.textContent = 'ğŸ” è‡ªå‹•ç²å–æ¨™é¡Œ';
       fetchButton.onclick = function() {
         const videoId = document.getElementById('youtubeId').value.trim();
         if (videoId) {
           fetchYouTubeTitle(videoId);
         } else {
           showStatus('è«‹å…ˆè¼¸å…¥ YouTube ID', 'error');
         }
       };
       
       // å°‡æŒ‰éˆ•æ’å…¥åˆ°è¼¸å…¥æ¡†å¾Œé¢
       const input = youtubeGroup.querySelector('input');
       input.parentNode.insertBefore(fetchButton, input.nextSibling);
     });
    
         // é»æ“Šå¤–éƒ¨é—œé–‰æ¨¡æ…‹æ¡†
     window.addEventListener('click', function(e) {
       const modal = document.getElementById('programModal');
       if (e.target === modal) {
         closeModal();
       }
     });
     
                  // èª¿è©¦æ™‚é–“æ§½åŠŸèƒ½
       function debugTimeSlots() {
         console.log('=== æ™‚é–“æ§½èª¿è©¦ä¿¡æ¯ ===');
         
         // æª¢æŸ¥æ‰€æœ‰æ™‚é–“æ§½
         const timeSlots = document.querySelectorAll('.program-slot');
         console.log(`ç¸½æ™‚é–“æ§½æ•¸é‡: ${timeSlots.length}`);
         
         // æª¢æŸ¥æ¯å€‹æ™‚æ®µçš„æ™‚é–“æ§½æ•¸é‡
         const periodGroups = document.querySelectorAll('.period-group');
         periodGroups.forEach((group, index) => {
           const periodName = group.querySelector('.period-header').textContent;
           const slots = group.querySelectorAll('.program-slot');
           console.log(`æ™‚æ®µ ${index + 1} (${periodName}): ${slots.length} å€‹æ™‚é–“æ§½`);
           
           // æª¢æŸ¥æ¯å€‹æ™‚é–“æ§½çš„é«˜åº¦
           slots.forEach((slot, slotIndex) => {
             const slotHeight = slot.offsetHeight;
             const slotWidth = slot.offsetWidth;
             const timeLabel = slot.querySelector('.slot-time');
             const timeText = timeLabel ? timeLabel.textContent : 'ç„¡æ™‚é–“';
             
             console.log(`  æ™‚é–“æ§½ ${slotIndex + 1} (${timeText}): ${slotWidth}px Ã— ${slotHeight}px`);
             
             // æª¢æŸ¥æ˜¯å¦æœ‰å…§å®¹è¢«åˆ‡æ‰
             const title = slot.querySelector('.program-title');
             if (title) {
               const titleHeight = title.offsetHeight;
               const titleScrollHeight = title.scrollHeight;
               if (titleScrollHeight > titleHeight) {
                 console.warn(`    âš ï¸ æ¨™é¡Œå…§å®¹è¢«åˆ‡æ‰: ${title.textContent.substring(0, 30)}...`);
               }
             }
           });
         });
         
         // æª¢æŸ¥æ—¥æœŸæ ¼å­çš„é«˜åº¦
         const dayCells = document.querySelectorAll('.calendar-day');
         dayCells.forEach((cell, index) => {
           const cellHeight = cell.offsetHeight;
           const cellScrollHeight = cell.scrollHeight;
           const dateAttr = cell.getAttribute('data-date');
           
           console.log(`æ—¥æœŸæ ¼å­ ${index + 1} (${dateAttr}): ${cellHeight}px é«˜åº¦, ${cellScrollHeight}px å…§å®¹é«˜åº¦`);
           
           if (cellScrollHeight > cellHeight) {
             console.warn(`  âš ï¸ æ—¥æœŸæ ¼å­å…§å®¹è¢«åˆ‡æ‰ï¼Œéœ€è¦æ»¾å‹•æŸ¥çœ‹`);
           }
         });
         
         alert(`æ™‚é–“æ§½èª¿è©¦ä¿¡æ¯å·²è¼¸å‡ºåˆ°æ§åˆ¶å°\nç¸½æ™‚é–“æ§½æ•¸é‡: ${timeSlots.length}`);
       }
       
       // èª¿è©¦ç‰ˆé¢åŠŸèƒ½
       function debugCalendarLayout() {
         console.log('=== ç‰ˆé¢èª¿è©¦ä¿¡æ¯ ===');
         
         // æª¢æŸ¥å®¹å™¨å¯¬åº¦
         const container = document.querySelector('.container');
         const calendarGrid = document.querySelector('.calendar-grid');
         const calendarHeader = document.querySelector('.calendar-header');
         const calendarBody = document.querySelector('.calendar-body');
         
         console.log(`å®¹å™¨å¯¬åº¦: ${container.offsetWidth}px`);
         console.log(`æœˆæ›†ç¶²æ ¼å¯¬åº¦: ${calendarGrid.offsetWidth}px`);
         console.log(`æœˆæ›†æ¨™é¡Œå¯¬åº¦: ${calendarHeader.offsetWidth}px`);
         console.log(`æœˆæ›†ä¸»é«”å¯¬åº¦: ${calendarBody.offsetWidth}px`);
         
         // æª¢æŸ¥æ¯å€‹æ˜ŸæœŸçš„å¯¬åº¦
         const headerCells = document.querySelectorAll('.calendar-header div');
         const dayCells = document.querySelectorAll('.calendar-day');
         
         console.log('\n=== æ˜ŸæœŸæ¨™é¡Œå¯¬åº¦ ===');
         headerCells.forEach((cell, index) => {
           const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
           console.log(`${dayNames[index]}: ${cell.offsetWidth}px`);
         });
         
         console.log('\n=== æ—¥æœŸæ ¼å­å¯¬åº¦ (å‰7å€‹) ===');
         for (let i = 0; i < 7; i++) {
           if (dayCells[i]) {
             console.log(`ç¬¬${i + 1}å€‹æ ¼å­: ${dayCells[i].offsetWidth}px`);
           }
         }
         
         // æª¢æŸ¥æ˜¯å¦æœ‰éš±è—çš„å…ƒç´ 
         const hiddenDays = document.querySelectorAll('.calendar-day[style*="display: none"]');
         console.log(`\néš±è—çš„æ—¥æœŸæ ¼å­æ•¸é‡: ${hiddenDays.length}`);
         
         alert(`ç‰ˆé¢èª¿è©¦ä¿¡æ¯å·²è¼¸å‡ºåˆ°æ§åˆ¶å°\nå®¹å™¨å¯¬åº¦: ${container.offsetWidth}px\næœˆæ›†å¯¬åº¦: ${calendarGrid.offsetWidth}px`);
       }
       
       // èª¿è©¦æ˜ŸæœŸè¨ˆç®—åŠŸèƒ½
       function debugWeekCalculation() {
         const year = currentDate.getFullYear();
         const month = currentDate.getMonth();
         
         console.log('=== æ˜ŸæœŸè¨ˆç®—èª¿è©¦ä¿¡æ¯ ===');
         console.log(`ç•¶å‰å¹´æœˆ: ${year}å¹´${month + 1}æœˆ`);
         
         // è¨ˆç®—æœˆæ›†æ•¸æ“š
         const firstDay = new Date(year, month, 1);
         const lastDay = new Date(year, month + 1, 0);
         const startDate = new Date(firstDay);
         startDate.setDate(startDate.getDate() - firstDay.getDay());
         
         console.log(`æœˆä»½ç¬¬ä¸€å¤©: ${firstDay.toDateString()} (æ˜ŸæœŸ${firstDay.getDay()})`);
         console.log(`æœˆä»½æœ€å¾Œä¸€å¤©: ${lastDay.toDateString()}`);
         console.log(`æœˆæ›†é–‹å§‹æ—¥æœŸ: ${startDate.toDateString()}`);
         
         // æª¢æŸ¥å‰6é€±çš„æ—¥æœŸ
         for (let week = 0; week < 6; week++) {
           console.log(`\nç¬¬${week + 1}é€±:`);
           for (let day = 0; day < 7; day++) {
             const currentDay = new Date(startDate);
             currentDay.setDate(startDate.getDate() + week * 7 + day);
             
             const isCurrentMonth = currentDay.getMonth() === month;
             const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][currentDay.getDay()];
             
             console.log(`  æ˜ŸæœŸ${dayOfWeek}: ${currentDay.getMonth() + 1}/${currentDay.getDate()} ${isCurrentMonth ? '(ç•¶æœˆ)' : '(å…¶ä»–æœˆ)'}`);
           }
         }
         
         // æª¢æŸ¥å¯¦éš›æ¸²æŸ“çš„æœˆæ›†å…ƒç´ 
         console.log('\n=== å¯¦éš›æ¸²æŸ“çš„æœˆæ›†å…ƒç´  ===');
         const calendarDays = document.querySelectorAll('.calendar-day');
         calendarDays.forEach((day, index) => {
           const dateAttr = day.getAttribute('data-date');
           const dayNumber = day.querySelector('.day-number');
           const dayNumberText = dayNumber ? dayNumber.textContent : 'ç„¡';
           console.log(`ç¬¬${index + 1}å€‹å…ƒç´ : data-date="${dateAttr}", é¡¯ç¤º="${dayNumberText}"`);
         });
         
         alert('æ˜ŸæœŸè¨ˆç®—èª¿è©¦ä¿¡æ¯å·²è¼¸å‡ºåˆ°æ§åˆ¶å°');
       }
       
       // èª¿è©¦æ™‚é–“éæ¿¾åŠŸèƒ½
       function debugTimeFilter() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = currentHour * 60 + currentMinute;
        const today = now.toISOString().split('T')[0];
        
        console.log('=== æ™‚é–“éæ¿¾èª¿è©¦ä¿¡æ¯ ===');
        console.log(`ç•¶å‰æ™‚é–“: ${currentHour}:${currentMinute.toString().padStart(2, '0')}`);
        console.log(`ç•¶å‰åˆ†é˜æ•¸: ${currentTime}`);
        console.log(`ä»Šå¤©æ—¥æœŸ: ${today}`);
        
        // æª¢æŸ¥ä»Šå¤©çš„æ™‚é–“æ§½
        const todayElement = document.querySelector(`[data-date="${today}"]`);
        if (todayElement) {
          const timeSlots = todayElement.querySelectorAll('.program-slot');
          console.log(`ä»Šå¤©é¡¯ç¤ºçš„æ™‚é–“æ§½æ•¸é‡: ${timeSlots.length}`);
          
          timeSlots.forEach(slot => {
            const timeLabel = slot.querySelector('.slot-time');
            if (timeLabel) {
              console.log(`é¡¯ç¤ºçš„æ™‚é–“æ§½: ${timeLabel.textContent}`);
            }
          });
        } else {
          console.log('æ‰¾ä¸åˆ°ä»Šå¤©çš„å…ƒç´ ');
        }
        
        alert(`èª¿è©¦ä¿¡æ¯å·²è¼¸å‡ºåˆ°æ§åˆ¶å°\nç•¶å‰æ™‚é–“: ${currentHour}:${currentMinute.toString().padStart(2, '0')}\nç•¶å‰åˆ†é˜æ•¸: ${currentTime}`);
      }
      
      // Contentful è¨ºæ–·åŠŸèƒ½
      async function diagnoseContentful() {
       try {
         showStatus('æ­£åœ¨è¨ºæ–· Contentful é€£æ¥...', 'info');
         
         const results = {
           connection: false,
           contentTypes: [],
           scheduleItems: 0,
           programs: 0,
           templates: 0
         };
         
         // æ¸¬è©¦åŸºæœ¬é€£æ¥
         try {
           const testResponse = await contentfulClient.getEntries({ limit: 1 });
           results.connection = true;
           console.log('âœ… Contentful é€£æ¥æˆåŠŸ');
         } catch (error) {
           console.error('âŒ Contentful é€£æ¥å¤±æ•—:', error);
           showStatus('Contentful é€£æ¥å¤±æ•—: ' + error.message, 'error');
           return;
         }
         
         // æª¢æŸ¥å¯ç”¨çš„å…§å®¹é¡å‹
         const contentTypes = ['scheduleItem', 'program', 'programTemplate', 'monthlySchedule'];
         
         for (const contentType of contentTypes) {
           try {
             const response = await contentfulClient.getEntries({
               content_type: contentType,
               limit: 1
             });
             results.contentTypes.push({
               type: contentType,
               available: true,
               count: response.total || 0
             });
             console.log(`âœ… ${contentType}: ${response.total || 0} å€‹é …ç›®`);
           } catch (error) {
             results.contentTypes.push({
               type: contentType,
               available: false,
               error: error.message
             });
             console.log(`âŒ ${contentType}: ä¸å¯ç”¨ - ${error.message}`);
           }
         }
         
         // ç”Ÿæˆè¨ºæ–·å ±å‘Š
         const report = `
Contentful è¨ºæ–·å ±å‘Š
==================
é€£æ¥ç‹€æ…‹: ${results.connection ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}

å¯ç”¨å…§å®¹é¡å‹:
${results.contentTypes.map(ct => 
  `${ct.available ? 'âœ…' : 'âŒ'} ${ct.type}: ${ct.available ? ct.count + ' å€‹é …ç›®' : ct.error}`
).join('\n')}

å»ºè­°:
${results.contentTypes.some(ct => ct.available) ? 
  'âœ… ç³»çµ±å¯ä»¥æ­£å¸¸é‹ä½œ' : 
  'âŒ éœ€è¦å‰µå»ºå…§å®¹é¡å‹ï¼Œè«‹åƒè€ƒ CONTENTFUL_SETUP.md'
}
         `;
         
         console.log(report);
         alert(report);
         showStatus('è¨ºæ–·å®Œæˆï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°', 'success');
         
       } catch (error) {
         console.error('è¨ºæ–·å¤±æ•—:', error);
         showStatus('è¨ºæ–·å¤±æ•—: ' + error.message, 'error');
       }
     }
  </script>
</body>
</html>
