<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>月曆節目管理 - 航向世界旅遊頻道</title>
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
         .container { 
       max-width: 1400px; 
       margin: 0 auto; 
       padding: 20px; 
       width: 100%;
       box-sizing: border-box;
     }
    
    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }
    .header p { color: #666; }
    
    .calendar-controls { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .month-nav { display: flex; align-items: center; gap: 15px; }
    .month-nav button { background: #2b71d2; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .month-nav button:hover { background: #1e5bb8; }
    .current-month { font-size: 1.2rem; font-weight: 600; color: #333; }
    
         .calendar-grid { 
       background: white; 
       border-radius: 10px; 
       overflow: hidden; 
       box-shadow: 0 2px 10px rgba(0,0,0,0.1);
       width: 100%;
       min-width: 100%;
     }
     .calendar-header { 
       display: grid; 
       grid-template-columns: repeat(7, 1fr); 
       background: #2b71d2; 
       color: white;
       width: 100%;
       min-width: 100%;
     }
         .calendar-header div { 
       padding: 15px; 
       text-align: center; 
       font-weight: 600; 
       width: 100%;
       box-sizing: border-box;
       flex: 1;
     }
    
         .calendar-body { 
       display: grid; 
       grid-template-columns: repeat(7, 1fr); 
       width: 100%;
       min-width: 100%;
     }
     .calendar-day { 
       min-height: 200px; 
       border: 1px solid #eee; 
       padding: 10px; 
       position: relative; 
       background: white;
       width: 100%;
       box-sizing: border-box;
       flex: 1;
       min-width: 0;
       overflow-y: auto;
     }
    .calendar-day:hover { background: #f8f9fa; }
    .calendar-day.other-month { background: #f8f9fa; color: #999; }
    .calendar-day.today { background: #e3f2fd; border-color: #2b71d2; }
    
         .day-number { font-weight: 600; margin-bottom: 5px; color: #333; }
     .day-programs { font-size: 0.8rem; }
     
     /* 時段分組樣式 */
     .period-group {
       margin-bottom: 15px;
       border: 1px solid #e9ecef;
       border-radius: 8px;
       overflow: hidden;
     }
     
     .period-header {
       background: #f8f9fa;
       padding: 8px 12px;
       font-weight: 600;
       font-size: 0.9rem;
       color: #495057;
       border-bottom: 1px solid #e9ecef;
     }
     
     .prime-time-header {
       background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
       color: white;
       font-weight: 700;
     }
     
           .period-slots {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 3px;
        padding: 8px;
        background: white;
        min-height: 60px;
      }
     
           .program-slot { 
        background: #e8f5e8; 
        border: 1px solid #4caf50; 
        border-radius: 4px; 
        padding: 6px 8px; 
        cursor: pointer;
        font-size: 0.7rem;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: all 0.2s ease;
        position: relative;
        word-wrap: break-word;
        overflow: hidden;
      }
     
     .program-slot:hover { 
       background: #c8e6c9; 
       transform: translateY(-1px);
       box-shadow: 0 2px 8px rgba(0,0,0,0.1);
     }
     
     .program-slot.empty { 
       background: #fff3cd; 
       border-color: #ffc107; 
       color: #856404;
       font-style: italic;
     }
     
     .program-slot.empty:hover { background: #ffeaa7; }
     
     .program-slot.prime-time {
       border-color: #ff6b6b;
       background: #ffe8e8;
     }
     
     .program-slot.prime-time:hover {
       background: #ffd8d8;
     }
     
     .slot-time {
       font-size: 0.6rem;
       color: #666;
       font-weight: 600;
       margin-bottom: 2px;
     }
     
           .program-title {
        font-size: 0.65rem;
        font-weight: 500;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        word-break: break-word;
        hyphens: auto;
        max-height: 2.4em;
      }
     
     .slot-status {
       font-size: 0.6rem;
       color: #999;
       font-style: italic;
     }
     
     .first-air-badge {
       position: absolute;
       top: 2px;
       right: 2px;
       background: #ff6b6b;
       color: white;
       font-size: 0.5rem;
       padding: 1px 4px;
       border-radius: 2px;
       font-weight: 600;
     }
    
    .program-modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: 1000;
    }
    .modal-content { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: white; 
      padding: 30px; 
      border-radius: 10px; 
      width: 90%; 
      max-width: 600px; 
      max-height: 80vh; 
      overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-group textarea { height: 80px; resize: vertical; }
    
    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    .btn:hover { background: #1e5bb8; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    
    /* 檔案上傳樣式 */
    .file-upload-container {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #f8f9fa;
      transition: all 0.3s ease;
    }
    
    .file-upload-container:hover {
      border-color: #2b71d2;
      background: #e3f2fd;
    }
    
    .file-upload-btn {
      background: linear-gradient(135deg, #2b71d2 0%, #1e5bb8 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(43, 113, 210, 0.3);
    }
    
    .file-upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(43, 113, 210, 0.4);
    }
    
    .file-info {
      margin-top: 10px;
      padding: 10px;
      background: #e8f5e8;
      border-radius: 6px;
      border: 1px solid #4caf50;
    }
    
    .upload-progress {
      margin-top: 10px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 5px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* 縮圖上傳樣式 */
    .thumbnail-upload-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .thumbnail-upload-btn, .auto-thumbnail-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .thumbnail-upload-btn:hover, .auto-thumbnail-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .auto-thumbnail-btn {
      background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
      color: #333;
    }
    
    .thumbnail-preview {
      position: relative;
      display: inline-block;
      max-width: 200px;
    }
    
    .thumbnail-preview img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }
    
    .remove-thumbnail {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .form-help {
      color: #6c757d;
      font-size: 12px;
      margin-top: 5px;
      display: block;
    }
    
    .template-panel { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .template-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
    .template-card { 
      background: #f8f9fa; 
      border: 2px solid #e9ecef; 
      border-radius: 8px; 
      padding: 15px; 
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    .template-card:hover { border-color: #2b71d2; background: #e3f2fd; }
    .template-card.selected { border-color: #2b71d2; background: #e3f2fd; }
    .template-card h4 { margin-bottom: 8px; color: #333; }
    .template-card p { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
    
    .status-bar { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      background: #333; 
      color: white; 
      padding: 15px 20px; 
      border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1001;
      display: none;
    }
    
    .auto-fill-panel { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .auto-fill-options { display: flex; gap: 15px; margin-top: 15px; }
    .auto-fill-option { 
      background: #f8f9fa; 
      border: 1px solid #ddd; 
      border-radius: 5px; 
      padding: 10px; 
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .auto-fill-option:hover { border-color: #2b71d2; background: #e3f2fd; }
    
    .stats { display: flex; gap: 20px; margin-top: 15px; }
    .stat-item { 
      background: #e3f2fd; 
      padding: 10px 15px; 
      border-radius: 5px; 
      text-align: center;
    }
    .stat-number { font-size: 1.5rem; font-weight: 600; color: #2b71d2; }
    .stat-label { font-size: 0.9rem; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📅 月曆節目管理系統</h1>
      <p>直觀的月曆介面，輕鬆管理整個月的節目安排</p>
    </div>
    
         <!-- 月曆控制 -->
     <div class="calendar-controls">
               <div class="month-nav">
          <button onclick="previousMonth()">◀ 上個月</button>
          <span class="current-month" id="currentMonth">2024年1月</span>
          <button onclick="nextMonth()">下個月 ▶</button>
          <div class="current-time" id="currentTime" style="margin-left: 20px; font-size: 0.9rem; color: #666;"></div>
        </div>
              <div>
          <button class="btn btn-secondary" onclick="window.location.href='admin-dashboard.html'">🏠 返回主控台</button>
          <button class="btn" onclick="saveToContentful()">💾 儲存到 Contentful</button>
          <button class="btn btn-secondary" onclick="exportCalendar()">📤 匯出月曆</button>
                     <button class="btn" onclick="showAutoFillPanel()">🔧 自動填充</button>
                       <button class="btn btn-secondary" onclick="diagnoseContentful()">🔍 診斷 Contentful</button>
            <button class="btn btn-secondary" onclick="debugTimeFilter()">🐛 調試時間過濾</button>
            <button class="btn btn-secondary" onclick="debugWeekCalculation()">📅 調試星期計算</button>
            <button class="btn btn-secondary" onclick="debugCalendarLayout()">📐 調試版面</button>
            <button class="btn btn-secondary" onclick="debugTimeSlots()">⏰ 調試時間槽</button>
            <button class="btn btn-danger" onclick="logout()">🚪 登出</button>
        </div>
     </div>
    
    <!-- 自動填充面板 -->
    <div class="auto-fill-panel" id="autoFillPanel" style="display: none;">
      <h3>🔧 自動填充選項</h3>
      <div class="auto-fill-options">
        <div class="auto-fill-option" onclick="autoFillEmptySlots()">
          <h4>🔄 自動填充空白時段</h4>
          <p>使用現有節目自動填充沒有安排的時段</p>
        </div>
        <div class="auto-fill-option" onclick="generateWeeklyPattern()">
          <h4>📅 生成週期模式</h4>
          <p>根據週一至週日的模式自動安排節目</p>
        </div>
        <div class="auto-fill-option" onclick="duplicateWeek()">
          <h4>📋 複製上週安排</h4>
          <p>將上週的節目安排複製到本週</p>
        </div>
      </div>
    </div>
    
    <!-- 節目範本面板 -->
    <div class="template-panel">
      <h3>📋 節目範本庫</h3>
      <p>點擊範本可快速添加到選定的時段</p>
      <div class="template-grid" id="templateGrid">
        <!-- 範本將由 JavaScript 動態生成 -->
      </div>
    </div>
    
    <!-- 統計資訊 -->
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number" id="totalPrograms">0</div>
        <div class="stat-label">總節目數</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="emptySlots">0</div>
        <div class="stat-label">空白時段</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="coverageRate">0%</div>
        <div class="stat-label">覆蓋率</div>
      </div>
    </div>
    
    <!-- 月曆網格 -->
    <div class="calendar-grid">
      <div class="calendar-header">
        <div>星期日</div>
        <div>星期一</div>
        <div>星期二</div>
        <div>星期三</div>
        <div>星期四</div>
        <div>星期五</div>
        <div>星期六</div>
      </div>
      <div class="calendar-body" id="calendarBody">
        <!-- 月曆內容將由 JavaScript 動態生成 -->
      </div>
    </div>
  </div>
  
  <!-- 節目編輯模態框 -->
  <div class="program-modal" id="programModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">編輯節目</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <form id="programForm">
        <input type="hidden" id="editDate">
        <input type="hidden" id="editTime">
        
                 <div class="form-group">
           <label>播出時間：</label>
           <input type="time" id="airTime" required readonly style="background-color: #f8f9fa; color: #495057;">
           <small class="form-help">時間由選定的時段自動帶出，不可修改</small>
         </div>
        
        <div class="form-group">
          <label>節目標題：</label>
          <input type="text" id="title" placeholder="例如：早安世界 - 日本東京晨間漫步" required>
        </div>
        
                 <div class="form-group">
           <label>節目時長：</label>
           <select id="duration" required>
             <option value="30" selected>30分鐘 (標準時段)</option>
             <option value="60">60分鐘 (雙時段)</option>
             <option value="90">90分鐘 (三時段)</option>
           </select>
           <small class="form-help">每個時段為30分鐘，可選擇多個時段組合</small>
         </div>
        
        <div class="form-group">
          <label>節目分類：</label>
          <select id="category" required>
            <option value="">-- 選擇分類 --</option>
            <option value="亞洲旅遊">亞洲旅遊</option>
            <option value="歐洲旅遊">歐洲旅遊</option>
            <option value="美洲旅遊">美洲旅遊</option>
            <option value="美食旅遊">美食旅遊</option>
            <option value="極地旅遊">極地旅遊</option>
            <option value="自然旅遊">自然旅遊</option>
            <option value="文化旅遊">文化旅遊</option>
            <option value="冒險旅遊">冒險旅遊</option>
          </select>
        </div>
        
                 <div class="form-group">
           <label>影片類型：</label>
           <select id="videoType" onchange="toggleVideoInput()">
             <option value="YouTube">YouTube</option>
             <option value="MP4">MP4 檔案</option>
           </select>
         </div>
         
         <div class="form-group" id="youtubeGroup">
           <label>YouTube ID：</label>
           <input type="text" id="youtubeId" placeholder="例如：dQw4w9WgXcQ">
         </div>
         
         <div class="form-group" id="mp4Group" style="display: none;">
           <label>MP4 影片：</label>
           <div class="file-upload-container">
             <input type="file" id="mp4File" accept="video/mp4,video/avi,video/mov,video/wmv" style="display: none;">
             <button type="button" class="file-upload-btn" onclick="document.getElementById('mp4File').click()">
               📁 選擇影片檔案
             </button>
             <div id="fileInfo" class="file-info" style="display: none;">
               <span id="fileName"></span>
               <span id="fileSize"></span>
             </div>
             <div id="uploadProgress" class="upload-progress" style="display: none;">
               <div class="progress-bar">
                 <div class="progress-fill" id="progressFill"></div>
               </div>
               <span id="progressText">0%</span>
             </div>
           </div>
           <small class="form-help">支援 MP4、AVI、MOV、WMV 格式，最大 500MB</small>
         </div>
         
         <div class="form-group">
           <label>節目描述：</label>
           <textarea id="description" placeholder="簡短描述節目內容..."></textarea>
         </div>
         
         <div class="form-group">
           <label>節目縮圖：</label>
           <div class="thumbnail-upload-container">
             <input type="file" id="thumbnailFile" accept="image/*" style="display: none;">
             <button type="button" class="thumbnail-upload-btn" onclick="document.getElementById('thumbnailFile').click()">
               🖼️ 選擇縮圖
             </button>
             <div id="thumbnailPreview" class="thumbnail-preview" style="display: none;">
               <img id="thumbnailImg" src="" alt="節目縮圖">
               <button type="button" class="remove-thumbnail" onclick="removeThumbnail()">❌</button>
             </div>
             <button type="button" class="auto-thumbnail-btn" onclick="generateAutoThumbnail()">
               🎬 自動生成縮圖
             </button>
           </div>
           <small class="form-help">建議尺寸 1280x720，支援 JPG、PNG 格式</small>
         </div>
        
                 <div class="form-group">
           <label>節目狀態：</label>
           <select id="status" onchange="toggleProgramSelection()">
             <option value="重播">重播</option>
             <option value="首播">首播</option>
             <option value="特別節目">特別節目</option>
           </select>
         </div>
         
         <div class="form-group" id="programSelectionGroup" style="display: none;">
           <label>選擇首播節目：</label>
           <select id="programSelection">
             <option value="">-- 從節目庫選擇 --</option>
           </select>
           <button type="button" class="btn btn-secondary" onclick="loadProgramLibrary()" style="margin-top: 5px;">
             🔄 重新載入節目庫
           </button>
         </div>
        
        <button type="submit" class="btn">💾 儲存節目</button>
        <button type="button" class="btn btn-danger" onclick="deleteProgram()">🗑️ 刪除節目</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">❌ 取消</button>
      </form>
    </div>
  </div>
  
  <!-- 狀態欄 -->
  <div class="status-bar" id="statusBar">
    <span id="statusMessage"></span>
  </div>

  <script>
    // 登入驗證檢查
    function checkAuth() {
      const user = sessionStorage.getItem('adminUser');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!user || !loginTime) {
        // 未登入，跳轉到登入頁面
        window.location.href = 'admin-login.html';
        return null;
      }
      
      // 檢查登入是否超過 8 小時
      const loginDate = new Date(loginTime);
      const now = new Date();
      const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
      
      if (hoursDiff >= 8) {
        // 登入已過期，清除 session 並跳轉到登入頁面
        sessionStorage.removeItem('adminUser');
        sessionStorage.removeItem('loginTime');
        window.location.href = 'admin-login.html';
        return null;
      }
      
      return JSON.parse(user);
    }
    
    // 登出功能
    function logout() {
      sessionStorage.removeItem('adminUser');
      sessionStorage.removeItem('loginTime');
      window.location.href = 'admin-login.html';
    }
    
    // 全域變數
    let currentDate = new Date(); // 使用當前實際日期
    let calendarData = {};
    let selectedTemplate = null;
    let selectedSlot = null;
    let currentUser = null;
    
    // 統一的資料管理
    const DATA_KEYS = {
      PROGRAMS: 'tv_programs_data',
      ARCHIVES: 'tv_archives_data',
      TEMPLATES: 'tv_templates_data'
    };
    
    // 載入所有節目資料
    function loadAllPrograms() {
      try {
        const savedData = localStorage.getItem(DATA_KEYS.PROGRAMS);
        if (savedData) {
          const allPrograms = JSON.parse(savedData);
          // 將所有節目資料轉換為月曆格式
          allPrograms.forEach(program => {
            const slotKey = `${program.airDate}-${program.airTime}`;
            calendarData[slotKey] = program;
          });
          console.log(`已載入 ${allPrograms.length} 個節目資料`);
        }
      } catch (error) {
        console.error('載入節目資料失敗:', error);
      }
    }
    
    // 儲存所有節目資料
    function saveAllPrograms() {
      try {
        const allPrograms = Object.values(calendarData);
        localStorage.setItem(DATA_KEYS.PROGRAMS, JSON.stringify(allPrograms));
        console.log(`已儲存 ${allPrograms.length} 個節目資料`);
        return allPrograms;
      } catch (error) {
        console.error('儲存節目資料失敗:', error);
        return [];
      }
    }
    
    // 同步資料到其他系統
    function syncDataToOtherSystems() {
      const allPrograms = saveAllPrograms();
      
      // 觸發自定義事件，通知其他系統資料已更新
      const event = new CustomEvent('programsDataUpdated', {
        detail: { programs: allPrograms }
      });
      window.dispatchEvent(event);
      
      console.log('資料已同步到其他系統');
    }
    
    // Contentful 設定
    const contentfulClient = contentful.createClient({
      space: 'os5wf90ljenp',
      accessToken: 'YOUR_DELIVERY_TOKEN'
    });
    
    // 節目範本
    const templates = [
      {
        id: 'morning',
        title: '早安世界',
        duration: 60,
        category: '亞洲旅遊',
        description: '跟著我們一起探索{地點}的早晨，從當地市場到著名景點的寧靜時光',
        status: '首播',
        color: '#4caf50'
      },
      {
        id: 'kitchen',
        title: '世界廚房',
        duration: 45,
        category: '美食旅遊',
        description: '深入{地點}，品嚐最道地的當地美食與特色料理',
        status: '重播',
        color: '#ff9800'
      },
      {
        id: 'adventure',
        title: '極地探險',
        duration: 60,
        category: '極地旅遊',
        description: '在{地點}追尋極光的神秘蹤跡，體驗極地探險的刺激',
        status: '特別節目',
        color: '#2196f3'
      },
      {
        id: 'city',
        title: '城市漫步',
        duration: 45,
        category: '歐洲旅遊',
        description: '沿著{地點}的街道漫步，感受這座城市的獨特魅力',
        status: '重播',
        color: '#9c27b0'
      },
      {
        id: 'nature',
        title: '自然奇觀',
        duration: 60,
        category: '自然旅遊',
        description: '探索{地點}的自然奇觀，感受大自然的壯麗景色',
        status: '首播',
        color: '#8bc34a'
      }
    ];
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 檢查用戶登入狀態
      currentUser = checkAuth();
      if (!currentUser) return;
      
      // 更新頁面標題顯示用戶資訊
      updateUserInfo();
      
              // 載入統一資料
        loadAllPrograms();
        
        loadTemplates();
        
        // 初始化時間顯示
        updateCurrentTime();
        
        // 每秒更新時間顯示
        setInterval(updateCurrentTime, 1000);
      renderCalendar();
      loadFromContentful();
      updateStats();
    });
    
    // 更新用戶資訊顯示
    function updateUserInfo() {
      const header = document.querySelector('.header h1');
      if (header && currentUser) {
        header.innerHTML = `📅 月曆節目管理系統 <span style="font-size: 0.8rem; color: #666; font-weight: normal;">- ${currentUser.name} (${currentUser.role}) | <span style="color: #2b71d2;">v1.2.0 (2025/08/28 10:35:00)</span></span>`;
      }
    }
    
    // 載入範本
    function loadTemplates() {
      const grid = document.getElementById('templateGrid');
      grid.innerHTML = templates.map(template => `
        <div class="template-card" onclick="selectTemplate('${template.id}')" data-template="${template.id}">
          <h4>${template.title}</h4>
          <p>${template.duration}分鐘 | ${template.category}</p>
          <p>${template.description.substring(0, 50)}...</p>
        </div>
      `).join('');
    }
    
    // 選擇範本
    function selectTemplate(templateId) {
      // 移除之前的選擇
      document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // 選擇新的範本
      const card = document.querySelector(`[data-template="${templateId}"]`);
      if (card) {
        card.classList.add('selected');
        selectedTemplate = templates.find(t => t.id === templateId);
        showStatus('範本已選擇，點擊月曆中的空白時段來添加節目', 'info');
      }
    }
    
    // 渲染月曆
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // 更新標題
      document.getElementById('currentMonth').textContent = `${year}年${month + 1}月`;
      
      // 計算月曆數據
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      // 修正：JavaScript 中 getDay() 返回 0-6，0 是星期日
      // 所以需要調整計算邏輯，確保月曆從星期日開始
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      
      const calendarBody = document.getElementById('calendarBody');
      calendarBody.innerHTML = '';
      
      // 生成6週的月曆
      for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(startDate);
          currentDay.setDate(startDate.getDate() + week * 7 + day);
          
          const isCurrentMonth = currentDay.getMonth() === month;
          const isToday = currentDay.toDateString() === new Date().toDateString();
          const dateString = currentDay.toISOString().split('T')[0];
          
          // 檢查是否為過去的日期（日期在今天之前）
          const today = new Date();
          today.setHours(0, 0, 0, 0); // 設定為今天的開始時間
          const isPastDate = currentDay < today;
          
          const dayElement = document.createElement('div');
          dayElement.className = `calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
          dayElement.setAttribute('data-date', dateString);
          
          // 如果是過去的日期，完全隱藏
          if (isPastDate) {
            dayElement.style.display = 'none';
          } else {
             dayElement.innerHTML = `
               <div class="day-number">${currentDay.getMonth() + 1}/${currentDay.getDate()}</div>
               <div class="day-programs" id="programs-${dateString}">
                 ${generateTimeSlots(dateString)}
               </div>
             `;
           }
          
          calendarBody.appendChild(dayElement);
        }
      }
      
      // 添加點擊事件
      addCalendarClickEvents();
    }
    
                   // 生成時間槽 - 新的時段設計
      function generateTimeSlots(dateString) {
        // 獲取當前時間
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = currentHour * 60 + currentMinute; // 轉換為分鐘
        
        // 檢查是否為今天
        const today = new Date().toISOString().split('T')[0];
        const isToday = dateString === today;
        
        const timeSlots = [
          // 00:00-06:00 時段 (12個節目，每30分鐘一個)
          { time: '00:00', label: '00:00', period: '00:00-06:00', slot: 1 },
          { time: '00:30', label: '00:30', period: '00:00-06:00', slot: 2 },
          { time: '01:00', label: '01:00', period: '00:00-06:00', slot: 3 },
          { time: '01:30', label: '01:30', period: '00:00-06:00', slot: 4 },
          { time: '02:00', label: '02:00', period: '00:00-06:00', slot: 5 },
          { time: '02:30', label: '02:30', period: '00:00-06:00', slot: 6 },
          { time: '03:00', label: '03:00', period: '00:00-06:00', slot: 7 },
          { time: '03:30', label: '03:30', period: '00:00-06:00', slot: 8 },
          { time: '04:00', label: '04:00', period: '00:00-06:00', slot: 9 },
          { time: '04:30', label: '04:30', period: '00:00-06:00', slot: 10 },
          { time: '05:00', label: '05:00', period: '00:00-06:00', slot: 11 },
          { time: '05:30', label: '05:30', period: '00:00-06:00', slot: 12 },
          
          // 06:00-12:00 時段 (12個節目，每30分鐘一個)
          { time: '06:00', label: '06:00', period: '06:00-12:00', slot: 1 },
          { time: '06:30', label: '06:30', period: '06:00-12:00', slot: 2 },
          { time: '07:00', label: '07:00', period: '06:00-12:00', slot: 3 },
          { time: '07:30', label: '07:30', period: '06:00-12:00', slot: 4 },
          { time: '08:00', label: '08:00', period: '06:00-12:00', slot: 5 },
          { time: '08:30', label: '08:30', period: '06:00-12:00', slot: 6 },
          { time: '09:00', label: '09:00', period: '06:00-12:00', slot: 7 },
          { time: '09:30', label: '09:30', period: '06:00-12:00', slot: 8 },
          { time: '10:00', label: '10:00', period: '06:00-12:00', slot: 9 },
          { time: '10:30', label: '10:30', period: '06:00-12:00', slot: 10 },
          { time: '11:00', label: '11:00', period: '06:00-12:00', slot: 11 },
          { time: '11:30', label: '11:30', period: '06:00-12:00', slot: 12 },
          
          // 12:00-18:00 時段 (12個節目，每30分鐘一個) - 首播放置區
          { time: '12:00', label: '12:00', period: '12:00-18:00', slot: 1, isPrimeTime: true },
          { time: '12:30', label: '12:30', period: '12:00-18:00', slot: 2, isPrimeTime: true },
          { time: '13:00', label: '13:00', period: '12:00-18:00', slot: 3, isPrimeTime: true },
          { time: '13:30', label: '13:30', period: '12:00-18:00', slot: 4, isPrimeTime: true },
          { time: '14:00', label: '14:00', period: '12:00-18:00', slot: 5, isPrimeTime: true },
          { time: '14:30', label: '14:30', period: '12:00-18:00', slot: 6, isPrimeTime: true },
          { time: '15:00', label: '15:00', period: '12:00-18:00', slot: 7, isPrimeTime: true },
          { time: '15:30', label: '15:30', period: '12:00-18:00', slot: 8, isPrimeTime: true },
          { time: '16:00', label: '16:00', period: '12:00-18:00', slot: 9, isPrimeTime: true },
          { time: '16:30', label: '16:30', period: '12:00-18:00', slot: 10, isPrimeTime: true },
          { time: '17:00', label: '17:00', period: '12:00-18:00', slot: 11, isPrimeTime: true },
          { time: '17:30', label: '17:30', period: '12:00-18:00', slot: 12, isPrimeTime: true },
          
          // 18:00-24:00 時段 (12個節目，每30分鐘一個)
          { time: '18:00', label: '18:00', period: '18:00-24:00', slot: 1 },
          { time: '18:30', label: '18:30', period: '18:00-24:00', slot: 2 },
          { time: '19:00', label: '19:00', period: '18:00-24:00', slot: 3 },
          { time: '19:30', label: '19:30', period: '18:00-24:00', slot: 4 },
          { time: '20:00', label: '20:00', period: '18:00-24:00', slot: 5 },
          { time: '20:30', label: '20:30', period: '18:00-24:00', slot: 6 },
          { time: '21:00', label: '21:00', period: '18:00-24:00', slot: 7 },
          { time: '21:30', label: '21:30', period: '18:00-24:00', slot: 8 },
          { time: '22:00', label: '22:00', period: '18:00-24:00', slot: 9 },
          { time: '22:30', label: '22:30', period: '18:00-24:00', slot: 10 },
          { time: '23:00', label: '23:00', period: '18:00-24:00', slot: 11 },
          { time: '23:30', label: '23:30', period: '18:00-24:00', slot: 12 }
        ];
        
                 // 過濾已過去的時間（僅對今天）
         const filteredTimeSlots = timeSlots.filter(slot => {
           if (!isToday) return true; // 非今天顯示所有時間
           
           // 將時間轉換為分鐘進行比較
           const [hour, minute] = slot.time.split(':').map(Number);
           const slotTime = hour * 60 + minute;
           
           // 動態過濾：隱藏當前時間之前的時間段
           // 例如：現在是晚上9點24分，隱藏晚上9點及之前的時間
           // 但保留一些緩衝時間，避免過度過濾
           const shouldShow = slotTime >= (currentTime - 120); // 保留120分鐘緩衝
           
           // 調試信息
           if (isToday && !shouldShow) {
             console.log(`隱藏時間槽: ${slot.time} (${slotTime}分鐘) < 當前時間 (${currentTime}分鐘)`);
           }
           
           return shouldShow;
         });
      
                              // 按時段分組
         const periodGroups = {
           '00:00-06:00': [],
           '06:00-12:00': [],
           '12:00-18:00': [],
           '18:00-24:00': []
         };
         
         filteredTimeSlots.forEach(slot => {
          const slotKey = `${dateString}-${slot.time}`;
          const program = calendarData[slotKey];
          
          const slotHtml = program ? 
            `<div class="program-slot ${slot.isPrimeTime ? 'prime-time' : ''}" data-slot="${slotKey}" style="background-color: ${program.color || '#e8f5e8'}">
              <div class="slot-time">${slot.label}</div>
              <div class="program-title">${program.title}</div>
              ${program.status === '首播' ? '<div class="first-air-badge">首播</div>' : ''}
            </div>` :
            `<div class="program-slot empty ${slot.isPrimeTime ? 'prime-time' : ''}" data-slot="${slotKey}">
              <div class="slot-time">${slot.label}</div>
              <div class="slot-status">空白</div>
            </div>`;
          
          periodGroups[slot.period].push(slotHtml);
        });
        
                 // 生成分組後的HTML，只顯示有時間槽的時段
         return Object.entries(periodGroups)
           .filter(([period, slots]) => slots.length > 0) // 只顯示有時間槽的時段
           .map(([period, slots]) => `
             <div class="period-group" data-period="${period}">
               <div class="period-header ${period === '12:00-18:00' ? 'prime-time-header' : ''}">
                 ${period} ${period === '12:00-18:00' ? '🌟 首播放置區' : ''}
               </div>
               <div class="period-slots">
                 ${slots.join('')}
               </div>
             </div>
           `).join('');
    }
    
    // 添加月曆點擊事件
    function addCalendarClickEvents() {
      document.querySelectorAll('.program-slot').forEach(slot => {
        slot.addEventListener('click', function() {
          const slotKey = this.getAttribute('data-slot');
          const [date, time] = slotKey.split('-');
          
          if (this.classList.contains('empty')) {
            // 空白時段 - 添加新節目
            if (selectedTemplate) {
              addProgramFromTemplate(date, time);
            } else {
              openProgramModal(date, time);
            }
          } else {
            // 已有節目 - 編輯
            openProgramModal(date, time, calendarData[slotKey]);
          }
        });
      });
    }
    
    // 從範本添加節目
    function addProgramFromTemplate(date, time) {
      const program = {
        ...selectedTemplate,
        title: selectedTemplate.title.replace('{地點}', '日本東京'), // 可以讓用戶選擇地點
        airDate: date,
        airTime: time,
        color: selectedTemplate.color
      };
      
      const slotKey = `${date}-${time}`;
      calendarData[slotKey] = program;
      
      updateProgramSlot(slotKey, program);
      updateStats();
      showStatus(`已添加節目：${program.title}`, 'success');
    }
    
         // 打開節目編輯模態框
     function openProgramModal(date, time, program = null) {
       document.getElementById('editDate').value = date;
       document.getElementById('editTime').value = time;
       document.getElementById('airTime').value = time;
       
       if (program) {
         // 編輯現有節目
         document.getElementById('modalTitle').textContent = '編輯節目';
         document.getElementById('title').value = program.title;
         document.getElementById('duration').value = program.duration;
         document.getElementById('category').value = program.category;
         document.getElementById('description').value = program.description;
         document.getElementById('youtubeId').value = program.youtubeId || '';
         document.getElementById('status').value = program.status;
         
         // 設定影片類型並切換輸入欄位
         if (program.videoType) {
           document.getElementById('videoType').value = program.videoType;
           toggleVideoInput();
         }
       } else {
         // 新增節目
         document.getElementById('modalTitle').textContent = '新增節目';
         document.getElementById('programForm').reset();
         document.getElementById('airTime').value = time; // 自動帶出選定的時間
       }
       
       document.getElementById('programModal').style.display = 'block';
     }
    
    // 關閉模態框
    function closeModal() {
      document.getElementById('programModal').style.display = 'none';
    }
    
    // 儲存節目
    document.getElementById('programForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!checkPermission('write')) {
        showStatus('您沒有編輯節目的權限', 'error');
        return;
      }
      
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('airTime').value;
      const slotKey = `${date}-${time}`;
      
             const videoType = document.getElementById('videoType').value;
       const videoId = videoType === 'YouTube' 
         ? document.getElementById('youtubeId').value 
         : document.getElementById('mp4Url').value;
       
       const program = {
         airDate: date,
         airTime: time,
         title: document.getElementById('title').value,
         duration: parseInt(document.getElementById('duration').value),
         category: document.getElementById('category').value,
         description: document.getElementById('description').value,
         videoType: videoType,
         videoId: videoId,
         status: document.getElementById('status').value,
         color: '#e8f5e8',
         createdBy: currentUser.email,
         createdAt: new Date().toISOString()
       };
      
      calendarData[slotKey] = program;
      updateProgramSlot(slotKey, program);
      updateStats();
      
      // 同步資料到其他系統
      syncDataToOtherSystems();
      
      closeModal();
      showStatus('節目已儲存並同步到其他系統', 'success');
    });
    
    // 檢查用戶權限
    function checkPermission(permission) {
      if (!currentUser) return false;
      
      // Super Admin 擁有所有權限
      if (currentUser.role === 'super_admin') return true;
      
      // 檢查特定權限
      if (currentUser.permissions.includes('all')) return true;
      
      return currentUser.permissions.includes(permission);
    }
    
    // 刪除節目
    function deleteProgram() {
      if (!checkPermission('delete')) {
        showStatus('您沒有刪除節目的權限', 'error');
        return;
      }
      
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('editTime').value;
      const slotKey = `${date}-${time}`;
      
      delete calendarData[slotKey];
      updateProgramSlot(slotKey, null);
      updateStats();
      
      // 同步資料到其他系統
      syncDataToOtherSystems();
      
      closeModal();
      showStatus('節目已刪除並同步到其他系統', 'success');
    }
    
    // 更新節目槽
    function updateProgramSlot(slotKey, program) {
      const slotElement = document.querySelector(`[data-slot="${slotKey}"]`);
      if (slotElement) {
        if (program) {
          slotElement.className = 'program-slot';
          slotElement.style.backgroundColor = program.color || '#e8f5e8';
          slotElement.textContent = program.title;
        } else {
          const [date, time] = slotKey.split('-');
          slotElement.className = 'program-slot empty';
          slotElement.style.backgroundColor = '';
          slotElement.textContent = `${time} - 空白`;
        }
      }
    }
    
               // 更新統計
      function updateStats() {
        const totalSlots = Object.keys(calendarData).length;
        const totalDays = 31; // 簡化計算
        const totalTimeSlots = totalDays * 48; // 48個時段 (4個時段 × 12個節目)
        const emptySlots = totalTimeSlots - totalSlots;
        const coverageRate = Math.round((totalSlots / totalTimeSlots) * 100);
        
        // 計算首播節目數量
        const firstAirPrograms = Object.values(calendarData).filter(p => p.status === '首播').length;
        
        document.getElementById('totalPrograms').textContent = totalSlots;
        document.getElementById('emptySlots').textContent = emptySlots;
        document.getElementById('coverageRate').textContent = `${coverageRate}%`;
        
        // 添加首播節目統計
        const statsContainer = document.querySelector('.stats');
        if (!document.getElementById('firstAirPrograms')) {
          const firstAirStat = document.createElement('div');
          firstAirStat.className = 'stat-item';
          firstAirStat.innerHTML = `
            <div class="stat-number" id="firstAirPrograms">0</div>
            <div class="stat-label">首播節目</div>
          `;
          statsContainer.appendChild(firstAirStat);
        }
        document.getElementById('firstAirPrograms').textContent = firstAirPrograms;
      }
      
      // 更新當前時間顯示
      function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = `🕐 當前時間: ${timeString}`;
        }
      }
    
    // 月曆導航
    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }
    
    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }
    
    // 自動填充功能
    function showAutoFillPanel() {
      const panel = document.getElementById('autoFillPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    function autoFillEmptySlots() {
      // 找到所有空白時段並自動填充
      const emptySlots = document.querySelectorAll('.program-slot.empty');
      let filledCount = 0;
      
      emptySlots.forEach((slot, index) => {
        const slotKey = slot.getAttribute('data-slot');
        const [date, time] = slotKey.split('-');
        
        // 使用循環的範本
        const template = templates[index % templates.length];
        const program = {
          ...template,
          title: template.title.replace('{地點}', '自動填充'),
          airDate: date,
          airTime: time,
          color: template.color
        };
        
        calendarData[slotKey] = program;
        updateProgramSlot(slotKey, program);
        filledCount++;
      });
      
      updateStats();
      showStatus(`已自動填充 ${filledCount} 個空白時段`, 'success');
    }
    
    function generateWeeklyPattern() {
      // 生成週期模式
      const weekPattern = [
        { template: templates[0], day: 1 }, // 週一：早安世界
        { template: templates[1], day: 2 }, // 週二：世界廚房
        { template: templates[2], day: 3 }, // 週三：極地探險
        { template: templates[3], day: 4 }, // 週四：城市漫步
        { template: templates[4], day: 5 }, // 週五：自然奇觀
        { template: templates[0], day: 6 }, // 週六：早安世界
        { template: templates[1], day: 0 }  // 週日：世界廚房
      ];
      
      // 清空現有數據
      calendarData = {};
      
      // 生成整個月的週期模式
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();
        const pattern = weekPattern.find(p => p.day === dayOfWeek);
        
        if (pattern) {
          const dateString = date.toISOString().split('T')[0];
          const timeSlots = ['06:00', '12:00', '18:00']; // 主要時段
          
          timeSlots.forEach(time => {
            const slotKey = `${dateString}-${time}`;
            const program = {
              ...pattern.template,
              title: pattern.template.title.replace('{地點}', '週期安排'),
              airDate: dateString,
              airTime: time,
              color: pattern.template.color
            };
            
            calendarData[slotKey] = program;
          });
        }
      }
      
      renderCalendar();
      updateStats();
      showStatus('已生成週期節目模式', 'success');
    }
    
         // Contentful 整合 - 載入節目資料
     async function loadFromContentful() {
       try {
         const year = currentDate.getFullYear();
         const month = currentDate.getMonth() + 1;
         const monthString = month.toString().padStart(2, '0');
         
         console.log('正在載入 Contentful 資料，月份:', `${year}-${monthString}`);
         
         // 嘗試載入節目表資料 (支援多種內容類型)
         let scheduleResponse = null;
         let programsResponse = null;
         
         // 方法1：嘗試載入 scheduleItem
         try {
           scheduleResponse = await contentfulClient.getEntries({
             content_type: 'scheduleItem',
             'fields.airDate[gte]': `${year}-${monthString}-01`,
             'fields.airDate[lt]': `${year}-${monthString}-32`,
             include: 2
           });
           console.log('成功載入 scheduleItem 資料:', scheduleResponse.items?.length || 0, '個項目');
         } catch (error) {
           console.log('scheduleItem 載入失敗，嘗試其他內容類型:', error.message);
         }
         
         // 方法2：如果 scheduleItem 失敗，嘗試載入 monthlySchedule
         if (!scheduleResponse || !scheduleResponse.items || scheduleResponse.items.length === 0) {
           try {
             const monthlyResponse = await contentfulClient.getEntries({
               content_type: 'monthlySchedule',
               'fields.monthYear': `${year}-${monthString}`,
               include: 2
             });
             
             if (monthlyResponse.items && monthlyResponse.items.length > 0) {
               const monthlySchedule = monthlyResponse.items[0];
               const programs = monthlySchedule.fields.programs || [];
               
               // 轉換為 scheduleItem 格式
               scheduleResponse = {
                 items: programs.map(program => ({
                   fields: {
                     airDate: program.fields.airDate,
                     airTime: program.fields.airTime,
                     title: program.fields.title,
                     duration: program.fields.duration,
                     category: program.fields.category,
                     description: program.fields.description,
                     videoType: program.fields.videoType,
                     videoId: program.fields.videoId,
                     status: program.fields.status,
                     thumbnail: program.fields.thumbnail
                   },
                   sys: { id: program.sys?.id || 'temp-' + Date.now() }
                 }))
               };
               console.log('成功載入 monthlySchedule 資料:', scheduleResponse.items.length, '個項目');
             }
           } catch (error) {
             console.log('monthlySchedule 載入失敗:', error.message);
           }
         }
         
         // 載入節目庫資料 (用於首播節目)
         try {
           programsResponse = await contentfulClient.getEntries({
             content_type: 'program',
             include: 2
           });
           console.log('成功載入節目庫資料:', programsResponse.items?.length || 0, '個節目');
         } catch (error) {
           console.log('節目庫載入失敗，嘗試其他內容類型:', error.message);
           
           // 嘗試載入 programTemplate
           try {
             programsResponse = await contentfulClient.getEntries({
               content_type: 'programTemplate',
               include: 2
             });
             console.log('成功載入 programTemplate 資料:', programsResponse.items?.length || 0, '個範本');
           } catch (error2) {
             console.log('programTemplate 載入也失敗:', error2.message);
           }
         }
         
         // 處理節目表資料
         if (scheduleResponse && scheduleResponse.items && scheduleResponse.items.length > 0) {
           scheduleResponse.items.forEach(item => {
             // 統一欄位名稱處理
             const fields = item.fields || {};
             
             // 日期和時間
             const date = fields.airDate || fields.播出日期;
             const time = fields.airTime || fields.播出時間;
             
             if (!date || !time) {
               console.warn('跳過無效的節目項目:', item);
               return;
             }
             
             const slotKey = `${date}-${time}`;
             
             calendarData[slotKey] = {
               airDate: date,
               airTime: time,
               title: fields.title || fields.節目標題 || '未命名節目',
               duration: fields.duration || fields.節目時長 || 30,
               category: fields.category || fields.節目分類 || '旅遊節目',
               description: fields.description || fields.節目描述 || '',
               videoType: fields.videoType || 'YouTube',
               videoId: fields.videoId || fields.youtubeId || fields.YouTubeID || '',
               status: fields.status || fields.節目狀態 || '重播',
               thumbnail: fields.thumbnail || fields.縮圖 || '',
               color: fields.colorCode || '#e8f5e8',
               contentfulId: item.sys.id,
               createdBy: fields.createdBy || 'admin',
               createdAt: fields.createdAt || new Date().toISOString()
             };
             
             console.log('已載入節目:', calendarData[slotKey].title, '時間:', time);
           });
         }
         
         // 儲存節目庫資料到本地
         if (programsResponse && programsResponse.items && programsResponse.items.length > 0) {
           const programs = programsResponse.items.map(item => {
             const fields = item.fields || {};
             
             return {
               id: item.sys.id,
               title: fields.title || fields.節目標題 || fields.templateName || '未命名節目',
               duration: fields.duration || fields.節目時長 || 30,
               category: fields.category || fields.節目分類 || '旅遊節目',
               description: fields.description || fields.節目描述 || '',
               videoType: fields.videoType || 'YouTube',
               videoId: fields.videoId || fields.youtubeId || fields.YouTubeID || '',
               thumbnail: fields.thumbnail || fields.縮圖 || '',
               status: '未播出',
               colorCode: fields.colorCode || '#e8f5e8',
               createdAt: item.sys.createdAt,
               updatedAt: item.sys.updatedAt
             };
           });
           
           localStorage.setItem('contentful_programs', JSON.stringify(programs));
           console.log(`已載入 ${programs.length} 個節目庫資料`);
           
           // 顯示載入的節目範例
           if (programs.length > 0) {
             console.log('節目庫範例:', programs[0]);
           }
         } else {
           console.log('沒有找到節目庫資料');
         }
         
         renderCalendar();
         updateStats();
         showStatus(`已從 Contentful 載入 ${scheduleResponse.items?.length || 0} 個節目表項目`, 'success');
         
       } catch (error) {
         console.log('Contentful 載入失敗:', error);
         showStatus('Contentful 載入失敗，使用本地數據', 'warning');
       }
     }
    
    async function saveToContentful() {
      if (!checkPermission('publish')) {
        showStatus('您沒有發布到 Contentful 的權限', 'error');
        return;
      }
      
      try {
        showStatus('正在儲存到 Contentful...', 'info');
        
        const programs = Object.values(calendarData);
        let savedCount = 0;
        
        for (const program of programs) {
          try {
            // 這裡應該調用 Contentful API 來創建或更新節目
            // 由於這是演示版本，我們只記錄到控制台
            console.log('儲存節目:', program);
            savedCount++;
          } catch (error) {
            console.error('儲存節目失敗:', error);
          }
        }
        
        showStatus(`成功儲存 ${savedCount} 個節目到 Contentful`, 'success');
      } catch (error) {
        console.error('Contentful 儲存失敗:', error);
        showStatus('Contentful 儲存失敗', 'error');
      }
    }
    
    // 匯出月曆
    function exportCalendar() {
      const data = {
        month: currentDate.getFullYear() + '-' + (currentDate.getMonth() + 1),
        programs: Object.values(calendarData)
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `calendar-${data.month}.json`;
      a.click();
      
      showStatus('月曆已匯出', 'success');
    }
    
    // 顯示狀態
    function showStatus(message, type) {
      const statusBar = document.getElementById('statusBar');
      const statusMessage = document.getElementById('statusMessage');
      
      statusMessage.textContent = message;
      statusBar.style.display = 'block';
      
      // 根據類型設定顏色
      statusBar.style.backgroundColor = type === 'success' ? '#4caf50' : 
                                      type === 'error' ? '#f44336' : 
                                      type === 'warning' ? '#ff9800' : '#333';
      
      setTimeout(() => {
        statusBar.style.display = 'none';
      }, 3000);
    }
    
         // 切換影片輸入欄位
     function toggleVideoInput() {
       const videoType = document.getElementById('videoType').value;
       const youtubeGroup = document.getElementById('youtubeGroup');
       const mp4Group = document.getElementById('mp4Group');
       
       if (videoType === 'YouTube') {
         youtubeGroup.style.display = 'block';
         mp4Group.style.display = 'none';
       } else {
         youtubeGroup.style.display = 'none';
         mp4Group.style.display = 'block';
       }
     }
     
     // 自動獲取 YouTube 影片標題
     async function fetchYouTubeTitle(videoId) {
       try {
         showStatus('正在獲取 YouTube 影片資訊...', 'info');
         
         // 使用 oEmbed API 獲取影片資訊（不需要 API Key）
         const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
         
         if (!response.ok) {
           throw new Error('無法獲取 YouTube 影片資訊');
         }
         
         const data = await response.json();
         
         if (data.title) {
           // 自動填充標題
           document.getElementById('title').value = data.title;
           
           // 自動生成縮圖
           const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
           document.getElementById('thumbnailImg').src = thumbnailUrl;
           document.getElementById('thumbnailPreview').style.display = 'block';
           
           showStatus('已自動獲取 YouTube 影片標題', 'success');
         } else {
           showStatus('找不到該 YouTube 影片', 'error');
         }
       } catch (error) {
         console.error('獲取 YouTube 標題失敗:', error);
         showStatus('無法獲取 YouTube 影片資訊，請手動輸入標題', 'warning');
       }
     }
    
    // 檔案上傳處理
    document.getElementById('mp4File').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // 檢查檔案大小 (500MB 限制)
        if (file.size > 500 * 1024 * 1024) {
          alert('檔案大小不能超過 500MB');
          this.value = '';
          return;
        }
        
        // 顯示檔案資訊
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        document.getElementById('fileInfo').style.display = 'block';
        
        // 模擬上傳進度
        simulateUpload();
      }
    });
    
    // 模擬上傳進度
    function simulateUpload() {
      const progressBar = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const uploadProgress = document.getElementById('uploadProgress');
      
      uploadProgress.style.display = 'block';
      let progress = 0;
      
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          setTimeout(() => {
            uploadProgress.style.display = 'none';
            showStatus('影片上傳完成！', 'success');
          }, 500);
        }
        
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
      }, 200);
    }
    
    // 縮圖上傳處理
    document.getElementById('thumbnailFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('thumbnailImg').src = e.target.result;
          document.getElementById('thumbnailPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
    
    // 移除縮圖
    function removeThumbnail() {
      document.getElementById('thumbnailFile').value = '';
      document.getElementById('thumbnailPreview').style.display = 'none';
    }
    
         // 自動生成縮圖
     function generateAutoThumbnail() {
       const videoType = document.getElementById('videoType').value;
       const videoId = document.getElementById('youtubeId').value;
       
       if (videoType === 'YouTube' && videoId) {
         // 使用 YouTube 縮圖
         const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
         document.getElementById('thumbnailImg').src = thumbnailUrl;
         document.getElementById('thumbnailPreview').style.display = 'block';
         showStatus('已自動生成 YouTube 縮圖', 'success');
       } else {
         showStatus('請先選擇 YouTube 影片並輸入 ID', 'error');
       }
     }
     
     // 切換節目選擇
     function toggleProgramSelection() {
       const status = document.getElementById('status').value;
       const programSelectionGroup = document.getElementById('programSelectionGroup');
       
       if (status === '首播') {
         programSelectionGroup.style.display = 'block';
         loadProgramLibrary();
       } else {
         programSelectionGroup.style.display = 'none';
       }
     }
     
     // 載入節目庫
     function loadProgramLibrary() {
       const savedPrograms = localStorage.getItem('contentful_programs');
       const programSelection = document.getElementById('programSelection');
       
       if (savedPrograms) {
         const programs = JSON.parse(savedPrograms);
         const unairedPrograms = programs.filter(p => p.status === '未播出');
         
         programSelection.innerHTML = '<option value="">-- 從節目庫選擇 --</option>';
         
         unairedPrograms.forEach(program => {
           const option = document.createElement('option');
           option.value = program.id;
           option.textContent = `${program.title} (${program.category}) - ${program.duration}分鐘`;
           programSelection.appendChild(option);
         });
         
         if (unairedPrograms.length === 0) {
           programSelection.innerHTML = '<option value="">-- 沒有可用的首播節目 --</option>';
         }
       } else {
         programSelection.innerHTML = '<option value="">-- 請先載入節目庫 --</option>';
       }
     }
     
     // 選擇節目庫節目
     document.getElementById('programSelection').addEventListener('change', function() {
       const selectedId = this.value;
       if (selectedId) {
         const savedPrograms = localStorage.getItem('contentful_programs');
         if (savedPrograms) {
           const programs = JSON.parse(savedPrograms);
           const selectedProgram = programs.find(p => p.id === selectedId);
           
           if (selectedProgram) {
             // 自動填充節目資訊
             document.getElementById('title').value = selectedProgram.title;
             document.getElementById('duration').value = selectedProgram.duration;
             document.getElementById('category').value = selectedProgram.category;
             document.getElementById('description').value = selectedProgram.description;
             document.getElementById('videoType').value = selectedProgram.videoType;
             
             if (selectedProgram.videoType === 'YouTube') {
               document.getElementById('youtubeId').value = selectedProgram.videoId;
               toggleVideoInput();
             }
             
             if (selectedProgram.thumbnail) {
               document.getElementById('thumbnailImg').src = selectedProgram.thumbnail;
               document.getElementById('thumbnailPreview').style.display = 'block';
             }
             
             showStatus('已載入節目資訊', 'success');
           }
         }
       }
     });
     
     // YouTube ID 輸入框事件監聽器 - 自動獲取標題
     document.getElementById('youtubeId').addEventListener('blur', function() {
       const videoId = this.value.trim();
       if (videoId && videoId.length >= 11) {
         // 延遲 1 秒後自動獲取標題，避免用戶還在輸入
         setTimeout(() => {
           if (this.value === videoId) { // 確認用戶沒有繼續修改
             fetchYouTubeTitle(videoId);
           }
         }, 1000);
       }
     });
     
     // 添加一個手動獲取按鈕的事件監聽器
     document.addEventListener('DOMContentLoaded', function() {
       // 在 YouTube ID 輸入框旁邊添加一個獲取按鈕
       const youtubeGroup = document.getElementById('youtubeGroup');
       
       // 創建獲取按鈕
       const fetchButton = document.createElement('button');
       fetchButton.type = 'button';
       fetchButton.className = 'btn btn-secondary';
       fetchButton.style.marginLeft = '10px';
       fetchButton.style.marginTop = '5px';
       fetchButton.style.fontSize = '12px';
       fetchButton.style.padding = '8px 12px';
       fetchButton.textContent = '🔍 自動獲取標題';
       fetchButton.onclick = function() {
         const videoId = document.getElementById('youtubeId').value.trim();
         if (videoId) {
           fetchYouTubeTitle(videoId);
         } else {
           showStatus('請先輸入 YouTube ID', 'error');
         }
       };
       
       // 將按鈕插入到輸入框後面
       const input = youtubeGroup.querySelector('input');
       input.parentNode.insertBefore(fetchButton, input.nextSibling);
     });
    
         // 點擊外部關閉模態框
     window.addEventListener('click', function(e) {
       const modal = document.getElementById('programModal');
       if (e.target === modal) {
         closeModal();
       }
     });
     
                  // 調試時間槽功能
       function debugTimeSlots() {
         console.log('=== 時間槽調試信息 ===');
         
         // 檢查所有時間槽
         const timeSlots = document.querySelectorAll('.program-slot');
         console.log(`總時間槽數量: ${timeSlots.length}`);
         
         // 檢查每個時段的時間槽數量
         const periodGroups = document.querySelectorAll('.period-group');
         periodGroups.forEach((group, index) => {
           const periodName = group.querySelector('.period-header').textContent;
           const slots = group.querySelectorAll('.program-slot');
           console.log(`時段 ${index + 1} (${periodName}): ${slots.length} 個時間槽`);
           
           // 檢查每個時間槽的高度
           slots.forEach((slot, slotIndex) => {
             const slotHeight = slot.offsetHeight;
             const slotWidth = slot.offsetWidth;
             const timeLabel = slot.querySelector('.slot-time');
             const timeText = timeLabel ? timeLabel.textContent : '無時間';
             
             console.log(`  時間槽 ${slotIndex + 1} (${timeText}): ${slotWidth}px × ${slotHeight}px`);
             
             // 檢查是否有內容被切掉
             const title = slot.querySelector('.program-title');
             if (title) {
               const titleHeight = title.offsetHeight;
               const titleScrollHeight = title.scrollHeight;
               if (titleScrollHeight > titleHeight) {
                 console.warn(`    ⚠️ 標題內容被切掉: ${title.textContent.substring(0, 30)}...`);
               }
             }
           });
         });
         
         // 檢查日期格子的高度
         const dayCells = document.querySelectorAll('.calendar-day');
         dayCells.forEach((cell, index) => {
           const cellHeight = cell.offsetHeight;
           const cellScrollHeight = cell.scrollHeight;
           const dateAttr = cell.getAttribute('data-date');
           
           console.log(`日期格子 ${index + 1} (${dateAttr}): ${cellHeight}px 高度, ${cellScrollHeight}px 內容高度`);
           
           if (cellScrollHeight > cellHeight) {
             console.warn(`  ⚠️ 日期格子內容被切掉，需要滾動查看`);
           }
         });
         
         alert(`時間槽調試信息已輸出到控制台\n總時間槽數量: ${timeSlots.length}`);
       }
       
       // 調試版面功能
       function debugCalendarLayout() {
         console.log('=== 版面調試信息 ===');
         
         // 檢查容器寬度
         const container = document.querySelector('.container');
         const calendarGrid = document.querySelector('.calendar-grid');
         const calendarHeader = document.querySelector('.calendar-header');
         const calendarBody = document.querySelector('.calendar-body');
         
         console.log(`容器寬度: ${container.offsetWidth}px`);
         console.log(`月曆網格寬度: ${calendarGrid.offsetWidth}px`);
         console.log(`月曆標題寬度: ${calendarHeader.offsetWidth}px`);
         console.log(`月曆主體寬度: ${calendarBody.offsetWidth}px`);
         
         // 檢查每個星期的寬度
         const headerCells = document.querySelectorAll('.calendar-header div');
         const dayCells = document.querySelectorAll('.calendar-day');
         
         console.log('\n=== 星期標題寬度 ===');
         headerCells.forEach((cell, index) => {
           const dayNames = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
           console.log(`${dayNames[index]}: ${cell.offsetWidth}px`);
         });
         
         console.log('\n=== 日期格子寬度 (前7個) ===');
         for (let i = 0; i < 7; i++) {
           if (dayCells[i]) {
             console.log(`第${i + 1}個格子: ${dayCells[i].offsetWidth}px`);
           }
         }
         
         // 檢查是否有隱藏的元素
         const hiddenDays = document.querySelectorAll('.calendar-day[style*="display: none"]');
         console.log(`\n隱藏的日期格子數量: ${hiddenDays.length}`);
         
         alert(`版面調試信息已輸出到控制台\n容器寬度: ${container.offsetWidth}px\n月曆寬度: ${calendarGrid.offsetWidth}px`);
       }
       
       // 調試星期計算功能
       function debugWeekCalculation() {
         const year = currentDate.getFullYear();
         const month = currentDate.getMonth();
         
         console.log('=== 星期計算調試信息 ===');
         console.log(`當前年月: ${year}年${month + 1}月`);
         
         // 計算月曆數據
         const firstDay = new Date(year, month, 1);
         const lastDay = new Date(year, month + 1, 0);
         const startDate = new Date(firstDay);
         startDate.setDate(startDate.getDate() - firstDay.getDay());
         
         console.log(`月份第一天: ${firstDay.toDateString()} (星期${firstDay.getDay()})`);
         console.log(`月份最後一天: ${lastDay.toDateString()}`);
         console.log(`月曆開始日期: ${startDate.toDateString()}`);
         
         // 檢查前6週的日期
         for (let week = 0; week < 6; week++) {
           console.log(`\n第${week + 1}週:`);
           for (let day = 0; day < 7; day++) {
             const currentDay = new Date(startDate);
             currentDay.setDate(startDate.getDate() + week * 7 + day);
             
             const isCurrentMonth = currentDay.getMonth() === month;
             const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][currentDay.getDay()];
             
             console.log(`  星期${dayOfWeek}: ${currentDay.getMonth() + 1}/${currentDay.getDate()} ${isCurrentMonth ? '(當月)' : '(其他月)'}`);
           }
         }
         
         // 檢查實際渲染的月曆元素
         console.log('\n=== 實際渲染的月曆元素 ===');
         const calendarDays = document.querySelectorAll('.calendar-day');
         calendarDays.forEach((day, index) => {
           const dateAttr = day.getAttribute('data-date');
           const dayNumber = day.querySelector('.day-number');
           const dayNumberText = dayNumber ? dayNumber.textContent : '無';
           console.log(`第${index + 1}個元素: data-date="${dateAttr}", 顯示="${dayNumberText}"`);
         });
         
         alert('星期計算調試信息已輸出到控制台');
       }
       
       // 調試時間過濾功能
       function debugTimeFilter() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = currentHour * 60 + currentMinute;
        const today = now.toISOString().split('T')[0];
        
        console.log('=== 時間過濾調試信息 ===');
        console.log(`當前時間: ${currentHour}:${currentMinute.toString().padStart(2, '0')}`);
        console.log(`當前分鐘數: ${currentTime}`);
        console.log(`今天日期: ${today}`);
        
        // 檢查今天的時間槽
        const todayElement = document.querySelector(`[data-date="${today}"]`);
        if (todayElement) {
          const timeSlots = todayElement.querySelectorAll('.program-slot');
          console.log(`今天顯示的時間槽數量: ${timeSlots.length}`);
          
          timeSlots.forEach(slot => {
            const timeLabel = slot.querySelector('.slot-time');
            if (timeLabel) {
              console.log(`顯示的時間槽: ${timeLabel.textContent}`);
            }
          });
        } else {
          console.log('找不到今天的元素');
        }
        
        alert(`調試信息已輸出到控制台\n當前時間: ${currentHour}:${currentMinute.toString().padStart(2, '0')}\n當前分鐘數: ${currentTime}`);
      }
      
      // Contentful 診斷功能
      async function diagnoseContentful() {
       try {
         showStatus('正在診斷 Contentful 連接...', 'info');
         
         const results = {
           connection: false,
           contentTypes: [],
           scheduleItems: 0,
           programs: 0,
           templates: 0
         };
         
         // 測試基本連接
         try {
           const testResponse = await contentfulClient.getEntries({ limit: 1 });
           results.connection = true;
           console.log('✅ Contentful 連接成功');
         } catch (error) {
           console.error('❌ Contentful 連接失敗:', error);
           showStatus('Contentful 連接失敗: ' + error.message, 'error');
           return;
         }
         
         // 檢查可用的內容類型
         const contentTypes = ['scheduleItem', 'program', 'programTemplate', 'monthlySchedule'];
         
         for (const contentType of contentTypes) {
           try {
             const response = await contentfulClient.getEntries({
               content_type: contentType,
               limit: 1
             });
             results.contentTypes.push({
               type: contentType,
               available: true,
               count: response.total || 0
             });
             console.log(`✅ ${contentType}: ${response.total || 0} 個項目`);
           } catch (error) {
             results.contentTypes.push({
               type: contentType,
               available: false,
               error: error.message
             });
             console.log(`❌ ${contentType}: 不可用 - ${error.message}`);
           }
         }
         
         // 生成診斷報告
         const report = `
Contentful 診斷報告
==================
連接狀態: ${results.connection ? '✅ 成功' : '❌ 失敗'}

可用內容類型:
${results.contentTypes.map(ct => 
  `${ct.available ? '✅' : '❌'} ${ct.type}: ${ct.available ? ct.count + ' 個項目' : ct.error}`
).join('\n')}

建議:
${results.contentTypes.some(ct => ct.available) ? 
  '✅ 系統可以正常運作' : 
  '❌ 需要創建內容類型，請參考 CONTENTFUL_SETUP.md'
}
         `;
         
         console.log(report);
         alert(report);
         showStatus('診斷完成，請查看控制台', 'success');
         
       } catch (error) {
         console.error('診斷失敗:', error);
         showStatus('診斷失敗: ' + error.message, 'error');
       }
     }
  </script>
</body>
</html>
