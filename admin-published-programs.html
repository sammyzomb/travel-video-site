<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>已上架節目管理</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
    .stat-number { font-size: 2rem; font-weight: 600; color: #2b71d2; margin-bottom: 5px; }
    .stat-label { color: #666; font-size: 0.9rem; }
    
    .controls { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .filter-group { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
    .filter-group label { font-weight: 600; color: #333; }
    .filter-group select, .filter-group input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; }
    
    .programs-table { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .table-header { background: #2b71d2; color: white; padding: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr auto; gap: 15px; font-weight: 600; }
    .table-row { padding: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr auto; gap: 15px; border-bottom: 1px solid #eee; align-items: center; }
    .table-row:hover { background: #f8f9fa; }
    .table-row:last-child { border-bottom: none; }
    
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
    .status-published { background: #d4edda; color: #155724; }
    .status-draft { background: #fff3cd; color: #856404; }
    .status-error { background: #f8d7da; color: #721c24; }
    
    .btn { background: #2b71d2; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
    .btn:hover { background: #1e5bb8; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    
    .empty-state { text-align: center; padding: 60px 20px; color: #666; }
    .empty-state h3 { margin-bottom: 10px; color: #333; }
    
    .back-btn { background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; margin-bottom: 20px; }
    .back-btn:hover { background: #5a6268; }
  </style>
</head>
<body>
  <div class="container">
    <a href="admin-dashboard.html" class="back-btn">← 返回儀表板</a>
    
    <div class="header">
      <h1>📺 已上架節目管理</h1>
      <p>查看和管理所有已上架到 Contentful 的節目</p>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalPrograms">0</div>
        <div class="stat-label">總節目數</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="publishedToday">0</div>
        <div class="stat-label">今日上架</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="thisWeek">0</div>
        <div class="stat-label">本週上架</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="thisMonth">0</div>
        <div class="stat-label">本月上架</div>
      </div>
    </div>
    
    <div class="controls">
      <div class="filter-group">
        <label>分類篩選：</label>
        <select id="categoryFilter">
          <option value="">全部分類</option>
          <option value="亞洲旅遊">亞洲旅遊</option>
          <option value="歐洲旅遊">歐洲旅遊</option>
          <option value="美洲旅遊">美洲旅遊</option>
          <option value="美食旅遊">美食旅遊</option>
          <option value="極地旅遊">極地旅遊</option>
          <option value="自然旅遊">自然旅遊</option>
          <option value="文化旅遊">文化旅遊</option>
          <option value="冒險旅遊">冒險旅遊</option>
        </select>
        
        <label>狀態篩選：</label>
        <select id="statusFilter">
          <option value="">全部狀態</option>
          <option value="首播">首播</option>
          <option value="重播">重播</option>
          <option value="特別節目">特別節目</option>
        </select>
        
        <label>日期範圍：</label>
        <input type="date" id="startDate">
        <span>至</span>
        <input type="date" id="endDate">
        
        <button class="btn" onclick="applyFilters()">篩選</button>
        <button class="btn btn-secondary" onclick="clearFilters()">清除篩選</button>
      </div>
    </div>
    
    <div class="programs-table">
      <div class="table-header">
        <div>節目標題</div>
        <div>播出日期</div>
        <div>播出時間</div>
        <div>分類</div>
        <div>狀態</div>
        <div>上架時間</div>
        <div>操作</div>
      </div>
      <div id="programsList">
        <div class="empty-state">
          <h3>📭 尚無已上架節目</h3>
          <p>請先在統一節目管理系統中上架節目</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let allPrograms = [];
    let filteredPrograms = [];
    
    document.addEventListener('DOMContentLoaded', function() {
      loadPublishedPrograms();
      updateStats();
      renderProgramsList();
    });
    
    function loadPublishedPrograms() {
      const published = localStorage.getItem('published_programs');
      allPrograms = published ? JSON.parse(published) : [];
      filteredPrograms = [...allPrograms];
    }
    
    function updateStats() {
      const today = new Date().toISOString().split('T')[0];
      const now = new Date();
      const weekStart = new Date(now.getTime() - (now.getDay() * 24 * 60 * 60 * 1000));
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      
      document.getElementById('totalPrograms').textContent = allPrograms.length;
      document.getElementById('publishedToday').textContent = allPrograms.filter(p => p.airDate === today).length;
      document.getElementById('thisWeek').textContent = allPrograms.filter(p => new Date(p.airDate) >= weekStart).length;
      document.getElementById('thisMonth').textContent = allPrograms.filter(p => new Date(p.airDate) >= monthStart).length;
    }
    
    function renderProgramsList() {
      const list = document.getElementById('programsList');
      
      if (filteredPrograms.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <h3>📭 沒有符合條件的節目</h3>
            <p>請調整篩選條件或先上架節目</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = filteredPrograms.map(program => `
        <div class="table-row">
          <div>
            <strong>${program.title}</strong>
            ${program.description ? `<br><small style="color: #666;">${program.description}</small>` : ''}
          </div>
          <div>${formatDate(program.airDate)}</div>
          <div>${program.airTime}</div>
          <div>${program.category}</div>
          <div>
            <span class="status-badge status-published">${program.status}</span>
          </div>
          <div>${formatDateTime(program.publishedAt)}</div>
          <div>
            <button class="btn btn-secondary" onclick="viewProgram('${program.airDate}', '${program.airTime}')">查看</button>
            <button class="btn btn-danger" onclick="unpublishProgram('${program.airDate}', '${program.airTime}')">下架</button>
          </div>
        </div>
      `).join('');
    }
    
    function applyFilters() {
      const category = document.getElementById('categoryFilter').value;
      const status = document.getElementById('statusFilter').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      filteredPrograms = allPrograms.filter(program => {
        if (category && program.category !== category) return false;
        if (status && program.status !== status) return false;
        if (startDate && program.airDate < startDate) return false;
        if (endDate && program.airDate > endDate) return false;
        return true;
      });
      
      renderProgramsList();
    }
    
    function clearFilters() {
      document.getElementById('categoryFilter').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      
      filteredPrograms = [...allPrograms];
      renderProgramsList();
    }
    
    function viewProgram(date, time) {
      // 跳轉到統一節目管理系統查看該節目
      window.open(`admin-calendar-unified.html?date=${date}&time=${time}`, '_blank');
    }
    
    function unpublishProgram(date, time) {
      if (confirm('確定要下架這個節目嗎？')) {
        // 從已上架列表中移除
        allPrograms = allPrograms.filter(p => !(p.airDate === date && p.airTime === time));
        localStorage.setItem('published_programs', JSON.stringify(allPrograms));
        
        // 更新本地節目狀態
        const events = JSON.parse(localStorage.getItem('calendar_events') || '{}');
        const dateEvents = events[date] || [];
        const updatedEvents = dateEvents.map(event => {
          if (event.time === time) {
            event.published = false;
            delete event.publishedAt;
          }
          return event;
        });
        events[date] = updatedEvents;
        localStorage.setItem('calendar_events', JSON.stringify(events));
        
        loadPublishedPrograms();
        updateStats();
        renderProgramsList();
        
        alert('節目已下架');
      }
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW');
    }
    
    function formatDateTime(dateTimeString) {
      const date = new Date(dateTimeString);
      return date.toLocaleString('zh-TW');
    }
  </script>
</body>
</html>
