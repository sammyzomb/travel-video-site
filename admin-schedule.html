<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¯€ç›®è¡¨ç®¡ç† - èˆªå‘ä¸–ç•Œæ—…éŠé »é“</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }
    .header p { color: #666; }
    
    .admin-panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-group textarea { height: 80px; resize: vertical; }
    
    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    .btn:hover { background: #1e5bb8; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    
    .programs-list { margin-top: 20px; }
    .program-item { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #2b71d2; }
    .program-item h3 { margin-bottom: 5px; color: #333; }
    .program-item p { color: #666; font-size: 14px; margin-bottom: 5px; }
    .program-item .time { font-weight: 600; color: #2b71d2; }
    
    .template-section { background: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .template-section h3 { margin-bottom: 10px; color: #495057; }
    
    .status { padding: 10px; border-radius: 5px; margin-bottom: 15px; }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    .user-info { 
      background: #e3f2fd; 
      padding: 10px 15px; 
      border-radius: 5px; 
      margin-bottom: 15px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
    }
    .user-info .user-details { color: #1976d2; font-weight: 500; }
    .user-info .logout-btn { 
      background: #f44336; 
      color: white; 
      border: none; 
      padding: 5px 10px; 
      border-radius: 3px; 
      cursor: pointer; 
      font-size: 12px;
    }
    .user-info .logout-btn:hover { background: #d32f2f; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ ç¯€ç›®è¡¨ç®¡ç†ç³»çµ±</h1>
      <p>è¼•é¬†ç®¡ç†æ‚¨çš„æ—…éŠç¯€ç›®è¡¨ï¼Œæ”¯æ´æ‰¹é‡æ·»åŠ å’Œç¯„æœ¬åŠŸèƒ½</p>
      <div style="margin-top: 15px;">
        <a href="admin-dashboard.html" class="btn btn-secondary" style="text-decoration: none; display: inline-block;">
          ğŸ  è¿”å›ä¸»æ§å°
        </a>
      </div>
    </div>
    
    <!-- ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º -->
    <div class="user-info" id="userInfo" style="display: none;">
      <div class="user-details" id="userDetails"></div>
      <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>
    
    <div class="admin-panel">
      <div id="status" class="status" style="display: none;"></div>
      
      <!-- ç¯€ç›®ç¯„æœ¬å€ -->
      <div class="template-section">
        <h3>ğŸ“‹ ç¯€ç›®ç¯„æœ¬</h3>
        <div class="form-group">
          <label>é¸æ“‡ç¯„æœ¬ï¼š</label>
          <select id="templateSelect">
            <option value="">-- é¸æ“‡ç¯€ç›®ç¯„æœ¬ --</option>
            <option value="morning">æ—©å®‰ä¸–ç•Œ - æ™¨é–“æ—…éŠ</option>
            <option value="kitchen">ä¸–ç•Œå»šæˆ¿ - ç¾é£Ÿä¹‹æ—…</option>
            <option value="adventure">æ¥µåœ°æ¢éšª - å†’éšªæ—…éŠ</option>
            <option value="city">åŸå¸‚æ¼«æ­¥ - åŸå¸‚æ—…éŠ</option>
            <option value="nature">è‡ªç„¶å¥‡è§€ - è‡ªç„¶æ—…éŠ</option>
          </select>
        </div>
        <button class="btn" onclick="loadTemplate()">è¼‰å…¥ç¯„æœ¬</button>
      </div>
      
      <!-- ç¯€ç›®æ·»åŠ è¡¨å–® -->
      <form id="programForm">
        <h3>ğŸ“º æ·»åŠ ç¯€ç›®</h3>
        
        <div class="form-group">
          <label>æ’­å‡ºæ—¥æœŸï¼š</label>
          <input type="date" id="airDate" required>
        </div>
        
        <div class="form-group">
          <label>æ’­å‡ºæ™‚é–“ï¼š</label>
          <input type="time" id="airTime" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æ¨™é¡Œï¼š</label>
          <input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šæ—©å®‰ä¸–ç•Œ - æ—¥æœ¬æ±äº¬æ™¨é–“æ¼«æ­¥" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æ™‚é•·ï¼ˆåˆ†é˜ï¼‰ï¼š</label>
          <input type="number" id="duration" min="15" max="180" value="60" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®åˆ†é¡ï¼š</label>
          <select id="category" required>
            <option value="">-- é¸æ“‡åˆ†é¡ --</option>
            <option value="äºæ´²æ—…éŠ">äºæ´²æ—…éŠ</option>
            <option value="æ­æ´²æ—…éŠ">æ­æ´²æ—…éŠ</option>
            <option value="ç¾æ´²æ—…éŠ">ç¾æ´²æ—…éŠ</option>
            <option value="ç¾é£Ÿæ—…éŠ">ç¾é£Ÿæ—…éŠ</option>
            <option value="æ¥µåœ°æ—…éŠ">æ¥µåœ°æ—…éŠ</option>
            <option value="è‡ªç„¶æ—…éŠ">è‡ªç„¶æ—…éŠ</option>
            <option value="æ–‡åŒ–æ—…éŠ">æ–‡åŒ–æ—…éŠ</option>
            <option value="å†’éšªæ—…éŠ">å†’éšªæ—…éŠ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æè¿°ï¼š</label>
          <textarea id="description" placeholder="ç°¡çŸ­æè¿°ç¯€ç›®å…§å®¹..."></textarea>
        </div>
        
        <div class="form-group">
          <label>YouTube IDï¼š</label>
          <input type="text" id="youtubeId" placeholder="ä¾‹å¦‚ï¼šdQw4w9WgXcQ">
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®ç‹€æ…‹ï¼š</label>
          <select id="status">
            <option value="é¦–æ’­">é¦–æ’­</option>
            <option value="é‡æ’­">é‡æ’­</option>
            <option value="ç‰¹åˆ¥ç¯€ç›®">ç‰¹åˆ¥ç¯€ç›®</option>
          </select>
        </div>
        
        <button type="submit" class="btn">æ·»åŠ ç¯€ç›®</button>
        <button type="button" class="btn btn-secondary" onclick="clearForm()">æ¸…ç©ºè¡¨å–®</button>
      </form>
      
      <!-- ç¯€ç›®åˆ—è¡¨ -->
      <div class="programs-list">
        <h3>ğŸ“‹ å·²æ·»åŠ çš„ç¯€ç›®</h3>
        <div id="programsList">
          <p style="color: #999; text-align: center; padding: 20px;">å°šæœªæ·»åŠ ç¯€ç›®</p>
        </div>
      </div>
      
      <!-- æ‰¹é‡æ“ä½œ -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <h3>ğŸ”„ æ‰¹é‡æ“ä½œ</h3>
        <button class="btn" onclick="exportToCSV()">åŒ¯å‡ºç‚º CSV</button>
        <button class="btn btn-secondary" onclick="importFromCSV()">å¾ CSV åŒ¯å…¥</button>
        <button class="btn" onclick="saveToContentful()">å„²å­˜åˆ° Contentful</button>
      </div>
    </div>
  </div>

  <script>
    // çµ±ä¸€çš„è³‡æ–™ç®¡ç†
    const DATA_KEYS = {
      PROGRAMS: 'tv_programs_data',
      ARCHIVES: 'tv_archives_data',
      TEMPLATES: 'tv_templates_data'
    };
    
    let allPrograms = [];
    
    // è¼‰å…¥æ‰€æœ‰ç¯€ç›®è³‡æ–™
    function loadAllPrograms() {
      try {
        const savedData = localStorage.getItem(DATA_KEYS.PROGRAMS);
        if (savedData) {
          allPrograms = JSON.parse(savedData);
          console.log(`ç¯€ç›®è¡¨ç®¡ç†ï¼šå·²è¼‰å…¥ ${allPrograms.length} å€‹ç¯€ç›®è³‡æ–™`);
          displayPrograms();
        }
      } catch (error) {
        console.error('è¼‰å…¥ç¯€ç›®è³‡æ–™å¤±æ•—:', error);
      }
    }
    
    // å„²å­˜æ‰€æœ‰ç¯€ç›®è³‡æ–™
    function saveAllPrograms() {
      try {
        localStorage.setItem(DATA_KEYS.PROGRAMS, JSON.stringify(allPrograms));
        console.log(`ç¯€ç›®è¡¨ç®¡ç†ï¼šå·²å„²å­˜ ${allPrograms.length} å€‹ç¯€ç›®è³‡æ–™`);
        
        // è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç³»çµ±è³‡æ–™å·²æ›´æ–°
        const event = new CustomEvent('programsDataUpdated', {
          detail: { programs: allPrograms }
        });
        window.dispatchEvent(event);
        
        return allPrograms;
      } catch (error) {
        console.error('å„²å­˜ç¯€ç›®è³‡æ–™å¤±æ•—:', error);
        return [];
      }
    }
    
    // é¡¯ç¤ºç¯€ç›®åˆ—è¡¨
    function displayPrograms() {
      const container = document.getElementById('programsList');
      if (!container) return;
      
      if (allPrograms.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ç›®å‰æ²’æœ‰ç¯€ç›®è³‡æ–™</p>';
        return;
      }
      
      // æŒ‰æ—¥æœŸæ’åº
      const sortedPrograms = allPrograms.sort((a, b) => new Date(a.airDate) - new Date(b.airDate));
      
      container.innerHTML = sortedPrograms.map(program => `
        <div class="program-item">
          <h3>${program.title}</h3>
          <p class="time">ğŸ“… ${program.airDate} | â° ${program.airTime} | â±ï¸ ${program.duration}åˆ†é˜</p>
          <p>ğŸ“‚ ${program.category} | ğŸ“Š ${program.status}</p>
          <p>${program.description || 'ç„¡æè¿°'}</p>
          <div style="margin-top: 10px;">
            <button class="btn btn-secondary" onclick="editProgram('${program.airDate}-${program.airTime}')">ç·¨è¼¯</button>
            <button class="btn btn-danger" onclick="deleteProgram('${program.airDate}-${program.airTime}')">åˆªé™¤</button>
          </div>
        </div>
      `).join('');
    }
    
    // ç·¨è¼¯ç¯€ç›®
    function editProgram(slotKey) {
      const program = allPrograms.find(p => `${p.airDate}-${p.airTime}` === slotKey);
      if (program) {
        // å¡«å……è¡¨å–®
        document.getElementById('title').value = program.title;
        document.getElementById('duration').value = program.duration;
        document.getElementById('category').value = program.category;
        document.getElementById('description').value = program.description || '';
        document.getElementById('youtubeId').value = program.youtubeId || '';
        document.getElementById('status').value = program.status;
        
        showStatus('è«‹ä¿®æ”¹ç¯€ç›®è³‡è¨Šå¾Œé»æ“Šå„²å­˜', 'info');
      }
    }
    
    // åˆªé™¤ç¯€ç›®
    function deleteProgram(slotKey) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¯€ç›®å—ï¼Ÿ')) {
        allPrograms = allPrograms.filter(p => `${p.airDate}-${p.airTime}` !== slotKey);
        saveAllPrograms();
        displayPrograms();
        showStatus('ç¯€ç›®å·²åˆªé™¤', 'success');
      }
    }
    
    // ç›£è½å…¶ä»–ç³»çµ±çš„è³‡æ–™æ›´æ–°
    window.addEventListener('programsDataUpdated', function(event) {
      console.log('ç¯€ç›®è¡¨ç®¡ç†ï¼šæ”¶åˆ°è³‡æ–™æ›´æ–°é€šçŸ¥');
      loadAllPrograms();
    });
    
    // ç™»å…¥é©—è­‰æª¢æŸ¥
    function checkAuth() {
      const user = sessionStorage.getItem('adminUser');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!user || !loginTime) {
        // æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢
        window.location.href = 'admin-login.html';
        return null;
      }
      
      // æª¢æŸ¥ç™»å…¥æ˜¯å¦è¶…é 8 å°æ™‚
      const loginDate = new Date(loginTime);
      const now = new Date();
      const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
      
      if (hoursDiff >= 8) {
        // ç™»å…¥å·²éæœŸï¼Œæ¸…é™¤ session ä¸¦è·³è½‰åˆ°ç™»å…¥é é¢
        sessionStorage.removeItem('adminUser');
        sessionStorage.removeItem('loginTime');
        window.location.href = 'admin-login.html';
        return null;
      }
      
      return JSON.parse(user);
    }
    
    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      sessionStorage.removeItem('adminUser');
      sessionStorage.removeItem('loginTime');
      window.location.href = 'admin-login.html';
    }
    
    // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
    function updateUserInfo() {
      const userInfo = document.getElementById('userInfo');
      const userDetails = document.getElementById('userDetails');
      
      if (currentUser) {
        userInfo.style.display = 'flex';
        userDetails.textContent = `æ­¡è¿ï¼Œ${currentUser.name} (${currentUser.role})`;
      }
    }
    
    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let programs = [];
    
    // ç¯€ç›®ç¯„æœ¬
    const templates = {
      morning: {
        title: 'æ—©å®‰ä¸–ç•Œ - {åœ°é»}æ™¨é–“æ¼«æ­¥',
        duration: 60,
        category: 'äºæ´²æ—…éŠ',
        description: 'è·Ÿè‘—æˆ‘å€‘ä¸€èµ·æ¢ç´¢{åœ°é»}çš„æ—©æ™¨ï¼Œå¾ç•¶åœ°å¸‚å ´åˆ°è‘—åæ™¯é»çš„å¯§éœæ™‚å…‰',
        status: 'é¦–æ’­'
      },
      kitchen: {
        title: 'ä¸–ç•Œå»šæˆ¿ - {åœ°é»}ç¾é£Ÿä¹‹æ—…',
        duration: 45,
        category: 'ç¾é£Ÿæ—…éŠ',
        description: 'æ·±å…¥{åœ°é»}ï¼Œå“åšæœ€é“åœ°çš„ç•¶åœ°ç¾é£Ÿèˆ‡ç‰¹è‰²æ–™ç†',
        status: 'é‡æ’­'
      },
      adventure: {
        title: 'æ¥µåœ°æ¢éšª - {åœ°é»}å†’éšªä¹‹æ—…',
        duration: 60,
        category: 'æ¥µåœ°æ—…éŠ',
        description: 'åœ¨{åœ°é»}è¿½å°‹æ¥µå…‰çš„ç¥ç§˜è¹¤è·¡ï¼Œé«”é©—æ¥µåœ°æ¢éšªçš„åˆºæ¿€',
        status: 'ç‰¹åˆ¥ç¯€ç›®'
      },
      city: {
        title: 'åŸå¸‚æ¼«æ­¥ - {åœ°é»}åŸå¸‚ä¹‹æ—…',
        duration: 45,
        category: 'æ­æ´²æ—…éŠ',
        description: 'æ²¿è‘—{åœ°é»}çš„è¡—é“æ¼«æ­¥ï¼Œæ„Ÿå—é€™åº§åŸå¸‚çš„ç¨ç‰¹é­…åŠ›',
        status: 'é‡æ’­'
      },
      nature: {
        title: 'è‡ªç„¶å¥‡è§€ - {åœ°é»}è‡ªç„¶ä¹‹æ—…',
        duration: 60,
        category: 'è‡ªç„¶æ—…éŠ',
        description: 'æ¢ç´¢{åœ°é»}çš„è‡ªç„¶å¥‡è§€ï¼Œæ„Ÿå—å¤§è‡ªç„¶çš„å£¯éº—æ™¯è‰²',
        status: 'é¦–æ’­'
      }
    };
    
    // è¼‰å…¥ç¯„æœ¬
    function loadTemplate() {
      const templateSelect = document.getElementById('templateSelect');
      const template = templates[templateSelect.value];
      
      if (template) {
        document.getElementById('title').value = template.title;
        document.getElementById('duration').value = template.duration;
        document.getElementById('category').value = template.category;
        document.getElementById('description').value = template.description;
        document.getElementById('status').value = template.status;
        
        showStatus('ç¯„æœ¬è¼‰å…¥æˆåŠŸï¼è«‹ä¿®æ”¹æ¨™é¡Œä¸­çš„{åœ°é»}ç‚ºå¯¦éš›åœ°é»', 'success');
      }
    }
    
    // æ¸…ç©ºè¡¨å–®
    function clearForm() {
      document.getElementById('programForm').reset();
      showStatus('è¡¨å–®å·²æ¸…ç©º', 'success');
    }
    
    // é¡¯ç¤ºç‹€æ…‹
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
      
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }
    
    // æ·»åŠ ç¯€ç›®
    document.getElementById('programForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const program = {
        airDate: document.getElementById('airDate').value,
        airTime: document.getElementById('airTime').value,
        title: document.getElementById('title').value,
        duration: document.getElementById('duration').value,
        category: document.getElementById('category').value,
        description: document.getElementById('description').value,
        youtubeId: document.getElementById('youtubeId').value,
        status: document.getElementById('status').value
      };
      
      programs.push(program);
      updateProgramsList();
      clearForm();
      showStatus('ç¯€ç›®æ·»åŠ æˆåŠŸï¼', 'success');
    });
    
    // æ›´æ–°ç¯€ç›®åˆ—è¡¨
    function updateProgramsList() {
      const list = document.getElementById('programsList');
      
      if (programs.length === 0) {
        list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">å°šæœªæ·»åŠ ç¯€ç›®</p>';
        return;
      }
      
      list.innerHTML = programs.map((program, index) => `
        <div class="program-item">
          <h3>${program.title}</h3>
          <p><span class="time">${program.airDate} ${program.airTime}</span> | ${program.duration}åˆ†é˜ | ${program.category}</p>
          <p>${program.description}</p>
          <button class="btn btn-secondary" onclick="removeProgram(${index})">åˆªé™¤</button>
        </div>
      `).join('');
    }
    
    // åˆªé™¤ç¯€ç›®
    function removeProgram(index) {
      programs.splice(index, 1);
      updateProgramsList();
      showStatus('ç¯€ç›®å·²åˆªé™¤', 'success');
    }
    
    // åŒ¯å‡ºç‚º CSV
    function exportToCSV() {
      if (programs.length === 0) {
        showStatus('æ²’æœ‰ç¯€ç›®å¯ä»¥åŒ¯å‡º', 'error');
        return;
      }
      
      const csv = [
        'airDate,airTime,title,duration,category,description,youtubeId,status',
        ...programs.map(p => `"${p.airDate}","${p.airTime}","${p.title}","${p.duration}","${p.category}","${p.description}","${p.youtubeId}","${p.status}"`)
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'programs.csv';
      a.click();
      
      showStatus('CSV æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
    }
    
    // å¾ CSV åŒ¯å…¥
    function importFromCSV() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const csv = e.target.result;
          const lines = csv.split('\n');
          const headers = lines[0].split(',');
          
          programs = lines.slice(1).filter(line => line.trim()).map(line => {
            const values = line.split(',').map(v => v.replace(/"/g, ''));
            const program = {};
            headers.forEach((header, index) => {
              program[header.trim()] = values[index] || '';
            });
            return program;
          });
          
          updateProgramsList();
          showStatus(`æˆåŠŸåŒ¯å…¥ ${programs.length} å€‹ç¯€ç›®`, 'success');
        };
        reader.readAsText(file);
      };
      input.click();
    }
    
    // å„²å­˜åˆ° Contentfulï¼ˆæ¨¡æ“¬ï¼‰
    function saveToContentful() {
      if (programs.length === 0) {
        showStatus('æ²’æœ‰ç¯€ç›®å¯ä»¥å„²å­˜', 'error');
        return;
      }
      
      showStatus('æ­£åœ¨å„²å­˜åˆ° Contentful...ï¼ˆé€™æ˜¯ä¸€å€‹æ¨¡æ“¬åŠŸèƒ½ï¼‰', 'success');
      
      // é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ Contentful API èª¿ç”¨
      console.log('è¦å„²å­˜çš„ç¯€ç›®ï¼š', programs);
    }
    
    // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
    document.getElementById('airDate').value = new Date().toISOString().split('T')[0];
    
    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    document.addEventListener('DOMContentLoaded', function() {
      // æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹
      currentUser = checkAuth();
      if (!currentUser) return;
      
      // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
      updateUserInfo();
    });
  </script>
</body>
</html>
